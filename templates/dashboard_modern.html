<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Speed Test Dashboard</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Apache ECharts -->
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    
    <style>
        /* Custom Tailwind Configuration */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        * {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        }
        
        /* Gradient Background */
        body {
            background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 50%, #06b6d4 100%);
            min-height: 100vh;
        }
        
        /* Glass-morphism Effect */
        .glass {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }
        
        .glass-dark {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, #3b82f6 0%, #06b6d4 100%);
            border-radius: 10px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(135deg, #2563eb 0%, #0891b2 100%);
        }
        
        /* Smooth Transitions */
        .smooth-transition {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        /* Collapsible Table Content */
        #tableContent {
            transition: max-height 0.4s ease-in-out, opacity 0.3s ease-in-out, margin-top 0.3s ease-in-out;
        }
        
        /* Hover Lift Effect */
        .hover-lift:hover {
            transform: translateY(-4px);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }
        
        /* Pulse Animation */
        @keyframes pulse-subtle {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.8; }
        }
        
        .pulse-subtle {
            animation: pulse-subtle 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        
        /* Chart Container */
        .chart-container {
            height: 400px;
            width: 100%;
            cursor: pointer;
            position: relative;
        }
        
        .chart-container:hover::after {
            content: 'üîç Click to expand';
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
            pointer-events: none;
            z-index: 100;
        }
        
        /* Modal Overlay */
        .chart-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.9);
            z-index: 9999;
            backdrop-filter: blur(10px);
        }
        
        .chart-modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.3s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .chart-modal-content {
            width: 95vw;
            height: 90vh;
            background: white;
            border-radius: 20px;
            padding: 20px;
            position: relative;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
        }
        
        .chart-modal-close {
            position: absolute;
            top: 20px;
            right: 20px;
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 20px;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: all 0.3s;
        }
        
        .chart-modal-close:hover {
            background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
            transform: scale(1.1);
        }
        
        .chart-modal-title {
            font-size: 24px;
            font-weight: bold;
            color: #1f2937;
            margin-bottom: 20px;
            padding-left: 10px;
        }
        
        .chart-modal-chart {
            width: 100%;
            height: calc(100% - 60px);
        }
        
        /* Badge Styles */
        .badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.875rem;
            font-weight: 600;
        }
        
        /* Input Focus Styles */
        input:focus, select:focus {
            outline: none;
            ring: 2px;
            ring-color: rgba(102, 126, 234, 0.5);
            border-color: #667eea;
        }
        
        /* Table Styles */
        .data-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
        }
        
        .data-table thead {
            background: linear-gradient(135deg, #3b82f6 0%, #06b6d4 100%);
            color: white;
        }
        
        .data-table th {
            padding: 1rem;
            text-align: left;
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        .data-table tbody tr {
            transition: all 0.2s, opacity 0.3s ease;
        }
        
        .data-table tbody tr:hover {
            background-color: rgba(59, 130, 246, 0.05);
            transform: scale(1.01);
        }
        
        .data-table td {
            padding: 0.875rem 1rem;
            border-bottom: 1px solid #e5e7eb;
        }
        
        /* Loading Spinner */
        .spinner {
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 3px solid white;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Skeleton Loading Animation */
        .skeleton {
            background: linear-gradient(90deg, #e5e7eb 25%, #f3f4f6 50%, #e5e7eb 75%);
            background-size: 200% 100%;
            animation: skeleton-loading 1.5s infinite;
            border-radius: 4px;
        }
        
        @keyframes skeleton-loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }
        
        .skeleton-text {
            height: 1.5rem;
            width: 60%;
            margin-bottom: 0.5rem;
        }
        
        .skeleton-stat {
            height: 2.5rem;
            width: 80%;
        }
        
        .skeleton-chart {
            height: 300px;
            width: 100%;
        }
        
        /* Hide skeleton when data loaded */
        .data-loaded .skeleton-wrapper {
            display: none;
        }
        
        .data-loaded .data-wrapper {
            display: block;
        }
        
        .data-wrapper {
            display: none;
        }
        
        /* Async loading overlay */
        .async-loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s;
        }
        
        .async-loading-overlay.active {
            opacity: 1;
            visibility: visible;
        }
    </style>
</head>
<body class="antialiased">
    <!-- Navigation Bar -->
    <nav class="glass-dark shadow-lg sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <div class="flex items-center space-x-3">
                    <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
                    </svg>
                    <span class="text-white text-xl font-bold">Speed Test Dashboard</span>
                </div>
                <div class="flex items-center space-x-4">
                    <span class="text-white text-sm">
                        <svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        </svg>
                        Last Updated: <span id="lastUpdate">{{ last_update }}</span>
                    </span>
                    <!-- Force Refresh Button -->
                    <button onclick="forceRefresh()" id="refreshBtn" 
                            class="flex items-center space-x-1 bg-white/20 hover:bg-white/30 text-white px-3 py-1.5 rounded-lg text-sm font-medium transition-all duration-200 hover:scale-105"
                            title="Bypass cache and get latest data">
                        <svg id="refreshIcon" class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                        </svg>
                        <span>Refresh</span>
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Stats Cards -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <!-- Download Speed Card -->
            <div class="glass rounded-2xl p-6 smooth-transition hover-lift">
                <div class="flex items-center justify-between">
                    <div class="flex-1">
                        <p class="text-sm font-medium text-gray-600 mb-1">Avg Download</p>
                        <p class="text-3xl font-bold text-indigo-600" data-stat="download">{% if async_mode %}<span class="skeleton skeleton-stat inline-block"></span>{% else %}{{ "%.2f"|format(stats.avg_download or 0) }}{% endif %}</p>
                        <p class="text-xs text-gray-500 mt-1">Mbps</p>
                        {% if trends and trends.download_change is defined %}
                        <div class="mt-2 flex items-center">
                            {% if trends.download_change > 0 %}
                            <svg class="w-4 h-4 text-green-500 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 10l7-7m0 0l7 7m-7-7v18"/>
                            </svg>
                            <span class="text-xs font-semibold text-green-600">+{{ trends.download_change }}%</span>
                            {% elif trends.download_change < 0 %}
                            <svg class="w-4 h-4 text-red-500 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 14l-7 7m0 0l-7-7m7 7V3"/>
                            </svg>
                            <span class="text-xs font-semibold text-red-600">{{ trends.download_change }}%</span>
                            {% else %}
                            <span class="text-xs font-semibold text-gray-500">No change</span>
                            {% endif %}
                            <span class="text-xs text-gray-400 ml-1">vs prev period</span>
                        </div>
                        {% endif %}
                    </div>
                    <div class="bg-indigo-100 rounded-full p-3">
                        <svg class="w-8 h-8 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M9 19l3 3m0 0l3-3m-3 3V10"/>
                        </svg>
                    </div>
                </div>
            </div>

            <!-- Upload Speed Card -->
            <div class="glass rounded-2xl p-6 smooth-transition hover-lift">
                <div class="flex items-center justify-between">
                    <div class="flex-1">
                        <p class="text-sm font-medium text-gray-600 mb-1">Avg Upload</p>
                        <p class="text-3xl font-bold text-purple-600" data-stat="upload">{% if async_mode %}<span class="skeleton skeleton-stat inline-block"></span>{% else %}{{ "%.2f"|format(stats.avg_upload or 0) }}{% endif %}</p>
                        <p class="text-xs text-gray-500 mt-1">Mbps</p>
                        {% if trends and trends.upload_change is defined %}
                        <div class="mt-2 flex items-center">
                            {% if trends.upload_change > 0 %}
                            <svg class="w-4 h-4 text-green-500 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 10l7-7m0 0l7 7m-7-7v18"/>
                            </svg>
                            <span class="text-xs font-semibold text-green-600">+{{ trends.upload_change }}%</span>
                            {% elif trends.upload_change < 0 %}
                            <svg class="w-4 h-4 text-red-500 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 14l-7 7m0 0l-7-7m7 7V3"/>
                            </svg>
                            <span class="text-xs font-semibold text-red-600">{{ trends.upload_change }}%</span>
                            {% else %}
                            <span class="text-xs font-semibold text-gray-500">No change</span>
                            {% endif %}
                            <span class="text-xs text-gray-400 ml-1">vs prev period</span>
                        </div>
                        {% endif %}
                    </div>
                    <div class="bg-purple-100 rounded-full p-3">
                        <svg class="w-8 h-8 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/>
                        </svg>
                    </div>
                </div>
            </div>

            <!-- Ping Card -->
            <div class="glass rounded-2xl p-6 smooth-transition hover-lift">
                <div class="flex items-center justify-between">
                    <div class="flex-1">
                        <p class="text-sm font-medium text-gray-600 mb-1">Avg Ping <span class="text-xs text-gray-400">(lower is better)</span></p>
                        <p class="text-3xl font-bold text-green-600" data-stat="ping">{% if async_mode %}<span class="skeleton skeleton-stat inline-block"></span>{% else %}{{ "%.2f"|format(stats.avg_ping or 0) }}{% endif %}</p>
                        <p class="text-xs text-gray-500 mt-1">ms</p>
                        {% if trends and trends.ping_change is defined %}
                        <div class="mt-2 flex items-center">
                            {% if trends.ping_change < 0 %}
                            <svg class="w-4 h-4 text-green-500 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 14l-7 7m0 0l-7-7m7 7V3"/>
                            </svg>
                            <span class="text-xs font-semibold text-green-600">{{ trends.ping_change }}% Better</span>
                            {% elif trends.ping_change > 0 %}
                            <svg class="w-4 h-4 text-red-500 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 10l7-7m0 0l7 7m-7-7v18"/>
                            </svg>
                            <span class="text-xs font-semibold text-red-600">+{{ trends.ping_change }}% Worse</span>
                            {% else %}
                            <span class="text-xs font-semibold text-gray-500">No change</span>
                            {% endif %}
                            <span class="text-xs text-gray-400 ml-1">vs prev period</span>
                        </div>
                        {% endif %}
                    </div>
                    <div class="bg-green-100 rounded-full p-3">
                        <svg class="w-8 h-8 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
                        </svg>
                    </div>
                </div>
            </div>

            <!-- Total Tests Card -->
            <div class="glass rounded-2xl p-6 smooth-transition hover-lift">
                <div class="flex items-center justify-between">
                    <div class="flex-1">
                        <p class="text-sm font-medium text-gray-600 mb-1">Total Tests</p>
                        <p class="text-3xl font-bold text-blue-600" data-stat="total">{% if async_mode %}<span class="skeleton skeleton-stat inline-block"></span>{% else %}{{ stats.total_tests or 0 }}{% endif %}</p>
                        <p class="text-xs text-gray-500 mt-1">completed</p>
                        {% if trends and trends.tests_change is defined %}
                        <div class="mt-2 flex items-center">
                            {% if trends.tests_change > 0 %}
                            <svg class="w-4 h-4 text-green-500 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 10l7-7m0 0l7 7m-7-7v18"/>
                            </svg>
                            <span class="text-xs font-semibold text-green-600">+{{ trends.tests_change }}%</span>
                            {% elif trends.tests_change < 0 %}
                            <svg class="w-4 h-4 text-red-500 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 14l-7 7m0 0l-7-7m7 7V3"/>
                            </svg>
                            <span class="text-xs font-semibold text-red-600">{{ trends.tests_change }}%</span>
                            {% else %}
                            <span class="text-xs font-semibold text-gray-500">No change</span>
                            {% endif %}
                            <span class="text-xs text-gray-400 ml-1">vs prev period</span>
                        </div>
                        {% endif %}
                    </div>
                    <div class="bg-blue-100 rounded-full p-3">
                        <svg class="w-8 h-8 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
                        </svg>
                    </div>
                </div>
            </div>
        </div>

        <!-- Speed Thresholds Info Banner -->
        <div class="glass rounded-2xl p-6 mb-8 smooth-transition border-l-4 border-blue-500">
            <h3 class="text-lg font-bold text-gray-800 mb-3 flex items-center">
                <svg class="w-5 h-5 mr-2 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                </svg>
                üìä Speed Thresholds by Connection (with 10.0% tolerance)
            </h3>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                <div class="bg-gray-50 rounded-lg p-3">
                    <span class="font-semibold text-gray-700">Ethernet:</span>
                    <span class="text-blue-600">‚â•180 Mbps</span>
                    <span class="text-xs text-gray-500">(200 ¬±10%)</span>
                </div>
                <div class="bg-gray-50 rounded-lg p-3">
                    <span class="font-semibold text-gray-700">Wi-Fi 5GHz:</span>
                    <span class="text-blue-600">‚â•180 Mbps</span>
                    <span class="text-xs text-gray-500">(200 ¬±10%)</span>
                </div>
                <div class="bg-gray-50 rounded-lg p-3">
                    <span class="font-semibold text-gray-700">Wi-Fi 2.4GHz:</span>
                    <span class="text-blue-600">‚â•90 Mbps</span>
                    <span class="text-xs text-gray-500">(100 ¬±10%)</span>
                </div>
                <div class="bg-gray-50 rounded-lg p-3">
                    <span class="font-semibold text-gray-700">Unknown:</span>
                    <span class="text-blue-600">‚â•135 Mbps</span>
                    <span class="text-xs text-gray-500">(150 ¬±10%)</span>
                </div>
            </div>
        </div>

        <!-- Connection Type Statistics -->
        {% if connection_stats %}
        <div class="glass rounded-2xl p-6 mb-8 smooth-transition">
            <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                <svg class="w-6 h-6 mr-2 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
                </svg>
                üìà Stats by Connection Type
            </h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                {% for conn_type, stats_data in connection_stats.items() %}
                <div class="bg-gradient-to-br from-white to-gray-50 rounded-xl p-5 border border-gray-200 hover:shadow-lg smooth-transition">
                    <div class="flex items-center justify-between mb-3">
                        <h4 class="text-lg font-bold text-gray-800">{{ conn_type }}</h4>
                        <span class="px-3 py-1 bg-blue-100 text-blue-800 rounded-full text-sm font-semibold">
                            {{ stats_data.count }} tests
                        </span>
                    </div>
                    <div class="space-y-2">
                        <div class="flex justify-between items-center">
                            <span class="text-sm text-gray-600">Average Speed:</span>
                            <span class="font-bold text-lg {% if stats_data.avg >= stats_data.min_threshold %}text-green-600{% else %}text-red-600{% endif %}">
                                {{ stats_data.avg }} Mbps
                            </span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-sm text-gray-600">Minimum Threshold:</span>
                            <span class="font-semibold text-gray-700">‚â•{{ stats_data.min_threshold }} Mbps</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-sm text-gray-600">Below Minimum:</span>
                            <span class="font-semibold {% if stats_data.below_pct > 50 %}text-red-600{% elif stats_data.below_pct > 25 %}text-yellow-600{% else %}text-green-600{% endif %}">
                                {{ stats_data.below_min }} ({{ stats_data.below_pct }}%)
                            </span>
                        </div>
                        <!-- Progress Bar -->
                        <div class="mt-3">
                            <div class="w-full bg-gray-200 rounded-full h-2">
                                <div class="{% if stats_data.below_pct > 50 %}bg-red-500{% elif stats_data.below_pct > 25 %}bg-yellow-500{% else %}bg-green-500{% endif %} h-2 rounded-full smooth-transition" 
                                     style="width: {{ (100 - stats_data.below_pct)|round(1) }}%"></div>
                            </div>
                            <p class="text-xs text-gray-500 mt-1 text-center">
                                {{ (100 - stats_data.below_pct)|round(1) }}% meeting threshold
                            </p>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}

        <!-- Additional Insights -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
            <!-- Days Below Expected Card -->
            <div class="glass rounded-2xl p-6 smooth-transition">
                <h3 class="text-lg font-bold text-gray-800 mb-4 flex items-center">
                    <svg class="w-5 h-5 mr-2 text-orange-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                    </svg>
                    Performance Alert
                </h3>
                <div class="text-center py-4">
                    <p class="text-4xl font-bold {% if summary.below_expected > summary.total_days / 2 %}text-red-600{% else %}text-green-600{% endif %} mb-2">
                        {{ summary.below_expected }} / {{ summary.total_days }}
                    </p>
                    <p class="text-sm text-gray-600">Days Below Expected Speed</p>
                    <p class="text-xs text-gray-500 mt-2">Threshold: Connection-specific (100-200 Mbps)</p>
                </div>
            </div>

            <!-- Top Server Card -->
            <div class="glass rounded-2xl p-6 smooth-transition">
                <h3 class="text-lg font-bold text-gray-800 mb-4 flex items-center">
                    <svg class="w-5 h-5 mr-2 text-teal-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 12h14M5 12a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v4a2 2 0 01-2 2M5 12a2 2 0 00-2 2v4a2 2 0 002 2h14a2 2 0 002-2v-4a2 2 0 00-2-2m-2-4h.01M17 16h.01"/>
                    </svg>
                    Most Used Server
                </h3>
                <div class="bg-gradient-to-br from-teal-50 to-blue-50 rounded-lg p-4">
                    <p class="text-sm font-semibold text-gray-700 break-words">
                        {{ summary.top_server_over_period }}
                    </p>
                    <p class="text-xs text-gray-500 mt-2">Format: Name ‚Äì Host ‚Äì City (Country)</p>
                </div>
            </div>
        </div>

        <!-- Public IP and Network Information -->
        {% if summary.public_ips %}
        <div class="glass rounded-2xl p-6 mb-8 smooth-transition">
            <div class="p-4 bg-gradient-to-r from-purple-50 to-pink-50 rounded-xl border-2 border-purple-200">
                <p class="text-sm font-bold text-purple-800 mb-3 flex items-center">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 01-9 9m9-9a9 9 0 00-9-9m9 9H3m9 9a9 9 0 01-9-9m9 9c1.657 0 3-4.03 3-9s-1.343-9-3-9m0 18c-1.657 0-3-4.03-3-9s1.343-9 3-9m-9 9a9 9 0 019-9"/>
                    </svg>
                    üåê Public IP Address(es) Detected:
                </p>
                <div class="flex flex-wrap gap-2 mb-3">
                    {% for ip in summary.public_ips %}
                    <span class="px-4 py-2 bg-white border-2 border-purple-300 text-purple-900 rounded-lg text-sm font-mono font-bold shadow-sm hover:shadow-md smooth-transition">
                        {{ ip }}
                    </span>
                    {% endfor %}
                </div>
                
                {% if summary.cidr_ranges %}
                <div class="mt-4 pt-3 border-t-2 border-purple-200">
                    <p class="text-xs font-bold text-purple-700 mb-2 flex items-center">
                        <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 3v2m6-2v2M9 19v2m6-2v2M5 9H3m2 6H3m18-6h-2m2 6h-2M7 19h10a2 2 0 002-2V7a2 2 0 00-2-2H7a2 2 0 00-2 2v10a2 2 0 002 2zM9 9h6v6H9V9z"/>
                        </svg>
                        üìä CIDR Network Range(s):
                    </p>
                    <div class="flex flex-wrap gap-2">
                        {% for cidr_info in summary.cidr_ranges %}
                        <div class="bg-gradient-to-r from-indigo-100 to-purple-100 border-2 border-indigo-300 rounded-lg px-3 py-2">
                            <div class="font-mono font-bold text-indigo-900 text-sm">{{ cidr_info.cidr }}</div>
                            <div class="text-xs text-indigo-700 mt-1">{{ cidr_info.count }} IP{{ 's' if cidr_info.count > 1 else '' }} in range</div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}
                
                <p class="text-xs text-purple-700 mt-3 font-medium">
                    üí° These are the public IP addresses from which speed tests were performed during this period
                </p>
            </div>
        </div>
        {% endif %}

        <!-- Percentile Statistics (Industry Standard) -->
        {% if percentiles %}
        <div class="glass rounded-2xl p-6 mb-8 smooth-transition">
            <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                <svg class="w-6 h-6 mr-2 text-cyan-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
                </svg>
                üìà Percentile Statistics <span class="text-sm font-normal text-gray-500 ml-2">(Industry Standard Metrics)</span>
            </h3>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <!-- Download Percentiles -->
                <div class="bg-gradient-to-br from-indigo-50 to-purple-50 rounded-xl p-5 border border-indigo-200">
                    <h4 class="font-semibold text-gray-700 mb-3 flex items-center">
                        <svg class="w-4 h-4 mr-1 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M9 19l3 3m0 0l3-3m-3 3V10"/>
                        </svg>
                        Download Speed
                    </h4>
                    <div class="space-y-2">
                        <div class="flex justify-between items-center">
                            <span class="text-sm text-gray-600">P50 (Median):</span>
                            <span class="font-bold text-indigo-700">{{ percentiles.download_p50 }} Mbps</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-sm text-gray-600">P95:</span>
                            <span class="font-bold text-indigo-700">{{ percentiles.download_p95 }} Mbps</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-sm text-gray-600">P99:</span>
                            <span class="font-bold text-indigo-700">{{ percentiles.download_p99 }} Mbps</span>
                        </div>
                    </div>
                </div>

                <!-- Upload Percentiles -->
                <div class="bg-gradient-to-br from-purple-50 to-pink-50 rounded-xl p-5 border border-purple-200">
                    <h4 class="font-semibold text-gray-700 mb-3 flex items-center">
                        <svg class="w-4 h-4 mr-1 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/>
                        </svg>
                        Upload Speed
                    </h4>
                    <div class="space-y-2">
                        <div class="flex justify-between items-center">
                            <span class="text-sm text-gray-600">P50 (Median):</span>
                            <span class="font-bold text-purple-700">{{ percentiles.upload_p50 }} Mbps</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-sm text-gray-600">P95:</span>
                            <span class="font-bold text-purple-700">{{ percentiles.upload_p95 }} Mbps</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-sm text-gray-600">P99:</span>
                            <span class="font-bold text-purple-700">{{ percentiles.upload_p99 }} Mbps</span>
                        </div>
                    </div>
                </div>

                <!-- Ping Percentiles -->
                <div class="bg-gradient-to-br from-green-50 to-teal-50 rounded-xl p-5 border border-green-200">
                    <h4 class="font-semibold text-gray-700 mb-3 flex items-center">
                        <svg class="w-4 h-4 mr-1 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
                        </svg>
                        Ping Latency
                    </h4>
                    <div class="space-y-2">
                        <div class="flex justify-between items-center">
                            <span class="text-sm text-gray-600">P50 (Median):</span>
                            <span class="font-bold text-green-700">{{ percentiles.ping_p50 }} ms</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-sm text-gray-600">P95:</span>
                            <span class="font-bold text-green-700">{{ percentiles.ping_p95 }} ms</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-sm text-gray-600">P99:</span>
                            <span class="font-bold text-green-700">{{ percentiles.ping_p99 }} ms</span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="mt-4 p-4 bg-gradient-to-r from-blue-50 to-cyan-50 rounded-lg border border-blue-200">
                <p class="text-sm text-gray-700 text-center">
                    <strong>üìä Quick Guide:</strong> 
                    <span class="font-semibold text-blue-700">P50</span> = Typical speed (half are faster, half slower) | 
                    <span class="font-semibold text-indigo-700">P95</span> = 95% of tests were this fast or faster than this value | 
                    <span class="font-semibold text-purple-700">P99</span> = Peak performance (99% achieved this or better than this value)
                </p>
                <p class="text-xs text-gray-600 text-center mt-2">
                    üí° <strong>For Download/Upload:</strong> Higher percentiles = Better performance | 
                    <strong>For Ping:</strong> Lower percentiles = Better latency (lower ping is better!)
                </p>
            </div>
        </div>
        {% endif %}

        <!-- Historical Best/Worst Records -->
        {% if historical_records %}
        <div class="glass rounded-2xl p-6 mb-8 smooth-transition">
            <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                <svg class="w-6 h-6 mr-2 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z"/>
                </svg>
                üèÜ Historical Records <span class="text-sm font-normal text-gray-500 ml-2">(All-Time Best Performance)</span>
            </h3>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                <!-- Best Download -->
                <div class="bg-gradient-to-br from-yellow-50 to-amber-50 rounded-xl p-4 border-2 border-yellow-300 smooth-transition hover:shadow-lg">
                    <div class="flex items-center mb-2">
                        <svg class="w-5 h-5 text-yellow-600 mr-2" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/>
                        </svg>
                        <h4 class="font-semibold text-gray-700">Fastest Download</h4>
                    </div>
                    <p class="text-2xl font-bold text-yellow-700 mb-1">{{ historical_records.best_download.value }} Mbps</p>
                    <p class="text-xs text-gray-600">{{ historical_records.best_download.date[:10] }}</p>
                    {% if historical_records.best_download.server %}
                    <p class="text-xs text-gray-500 mt-1 truncate" title="{{ historical_records.best_download.server }}">{{ historical_records.best_download.server[:30] }}...</p>
                    {% endif %}
                </div>

                <!-- Worst Download -->
                <div class="bg-gradient-to-br from-red-50 to-orange-50 rounded-xl p-4 border-2 border-red-200 smooth-transition hover:shadow-lg">
                    <div class="flex items-center mb-2">
                        <svg class="w-5 h-5 text-red-600 mr-2" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/>
                        </svg>
                        <h4 class="font-semibold text-gray-700">Slowest Download</h4>
                    </div>
                    <p class="text-2xl font-bold text-red-700 mb-1">{{ historical_records.worst_download.value }} Mbps</p>
                    <p class="text-xs text-gray-600">{{ historical_records.worst_download.date[:10] }}</p>
                </div>

                <!-- Best Upload -->
                <div class="bg-gradient-to-br from-blue-50 to-cyan-50 rounded-xl p-4 border-2 border-blue-300 smooth-transition hover:shadow-lg">
                    <div class="flex items-center mb-2">
                        <svg class="w-5 h-5 text-blue-600 mr-2" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/>
                        </svg>
                        <h4 class="font-semibold text-gray-700">Fastest Upload</h4>
                    </div>
                    <p class="text-2xl font-bold text-blue-700 mb-1">{{ historical_records.best_upload.value }} Mbps</p>
                    <p class="text-xs text-gray-600">{{ historical_records.best_upload.date[:10] }}</p>
                </div>

                <!-- Lowest Ping -->
                <div class="bg-gradient-to-br from-green-50 to-emerald-50 rounded-xl p-4 border-2 border-green-300 smooth-transition hover:shadow-lg">
                    <div class="flex items-center mb-2">
                        <svg class="w-5 h-5 text-green-600 mr-2" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/>
                        </svg>
                        <h4 class="font-semibold text-gray-700">Lowest Ping</h4>
                    </div>
                    <p class="text-2xl font-bold text-green-700 mb-1">{{ historical_records.lowest_ping.value }} ms</p>
                    <p class="text-xs text-gray-600">{{ historical_records.lowest_ping.date[:10] }}</p>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Filters Panel -->
        <div class="glass rounded-2xl p-6 mb-8 smooth-transition">
            <div class="flex items-center justify-between mb-6">
                <h2 class="text-2xl font-bold text-gray-800 flex items-center">
                    <svg class="w-6 h-6 mr-2 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z"/>
                    </svg>
                    Filters
                </h2>
                <button onclick="resetFilters()" class="px-4 py-2 bg-gradient-to-r from-blue-500 to-cyan-500 text-white rounded-lg hover:from-blue-600 hover:to-cyan-600 smooth-transition shadow-md hover:shadow-lg">
                    Reset Filters
                </button>
            </div>

            <!-- Quick Filters -->
            {% if quick_filters %}
            <div class="bg-gradient-to-r from-cyan-50 to-blue-50 rounded-xl p-5 mb-6 border-2 border-cyan-200">
                <h3 class="text-sm font-bold text-gray-700 mb-4 flex items-center">
                    <svg class="w-4 h-4 mr-2 text-cyan-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
                    </svg>
                    ‚ö° Quick Filters (Click to Apply)
                </h3>
                <div class="flex flex-wrap gap-2">
                    <!-- Performance Quick Filters -->
                    {% if quick_filters.below_threshold > 0 %}
                    <button type="button" onclick="applyQuickFilter('below_threshold')" class="quick-filter-btn px-4 py-2 bg-white border-2 border-orange-300 text-orange-700 rounded-lg hover:bg-orange-50 smooth-transition shadow-sm hover:shadow-md font-medium text-sm">
                        üîª Below 200 Mbps
                        <span class="ml-1 px-2 py-0.5 bg-orange-100 rounded-full text-xs">{{ quick_filters.below_threshold }}</span>
                    </button>
                    {% endif %}
                    
                    {% if quick_filters.performance_drops > 0 %}
                    <button type="button" onclick="applyQuickFilter('performance_drops')" class="quick-filter-btn px-4 py-2 bg-white border-2 border-red-300 text-red-700 rounded-lg hover:bg-red-50 smooth-transition shadow-sm hover:shadow-md font-medium text-sm">
                        ‚ö†Ô∏è Drops <100 Mbps
                        <span class="ml-1 px-2 py-0.5 bg-red-100 rounded-full text-xs">{{ quick_filters.performance_drops }}</span>
                    </button>
                    {% endif %}
                    
                    {% if quick_filters.high_ping > 0 %}
                    <button type="button" onclick="applyQuickFilter('high_ping')" class="quick-filter-btn px-4 py-2 bg-white border-2 border-yellow-300 text-yellow-700 rounded-lg hover:bg-yellow-50 smooth-transition shadow-sm hover:shadow-md font-medium text-sm">
                        üì∂ High Ping >20ms
                        <span class="ml-1 px-2 py-0.5 bg-yellow-100 rounded-full text-xs">{{ quick_filters.high_ping }}</span>
                    </button>
                    {% endif %}
                    
                    <!-- ISP Quick Filters -->
                    {% for isp in quick_filters.isps %}
                    <button type="button" onclick="applyQuickFilter('isp', '{{ isp.name }}')" class="quick-filter-btn px-4 py-2 bg-white border-2 border-blue-300 text-blue-700 rounded-lg hover:bg-blue-50 smooth-transition shadow-sm hover:shadow-md font-medium text-sm">
                        üåê {{ isp.name }}
                        <span class="ml-1 px-2 py-0.5 bg-blue-100 rounded-full text-xs">{{ isp.count }}</span>
                    </button>
                    {% endfor %}
                    
                    <!-- Connection Type Quick Filters -->
                    {% for conn in quick_filters.connection_types %}
                    <button type="button" onclick="applyQuickFilter('connection', '{{ conn.name }}')" class="quick-filter-btn px-4 py-2 bg-white border-2 border-purple-300 text-purple-700 rounded-lg hover:bg-purple-50 smooth-transition shadow-sm hover:shadow-md font-medium text-sm">
                        üì° {{ conn.name }}
                        <span class="ml-1 px-2 py-0.5 bg-purple-100 rounded-full text-xs">{{ conn.count }}</span>
                    </button>
                    {% endfor %}
                    
                    <!-- Clear Quick Filters Button -->
                    <button type="button" onclick="clearQuickFilters()" class="quick-filter-btn px-4 py-2 bg-white border-2 border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 smooth-transition shadow-sm hover:shadow-md font-medium text-sm">
                        üîÑ Clear Filters
                    </button>
                </div>
            </div>
            {% endif %}
            
            <!-- Primary Controls (GET - No Form) -->
            <div class="bg-gradient-to-r from-blue-50 to-indigo-50 rounded-xl p-5 mb-6 border-2 border-blue-200">
                <h3 class="text-sm font-bold text-gray-700 mb-4 flex items-center">
                    <svg class="w-4 h-4 mr-2 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                    ‚öôÔ∏è Primary Controls
                </h3>
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <!-- Host Selector -->
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">üñ•Ô∏è Host</label>
                        <select id="hostSelector" class="w-full px-4 py-2.5 border border-gray-300 rounded-lg smooth-transition focus:ring-2 focus:ring-purple-500 focus:border-purple-500 font-medium bg-gradient-to-r from-purple-50 to-indigo-50">
                            <option value="" {% if not selected_host %}selected{% endif %}>All Hosts</option>
                            {% if available_hosts %}
                                {% for host in available_hosts %}
                                    {% if host != '_legacy' %}
                                        <option value="{{ host }}" {% if selected_host == host %}selected{% endif %}>{{ host }}</option>
                                    {% endif %}
                                {% endfor %}
                                {% for host in available_hosts %}
                                    {% if host == '_legacy' %}
                                        <option value="_legacy" {% if selected_host == '_legacy' %}selected{% endif %}>Legacy Data</option>
                                    {% endif %}
                                {% endfor %}
                            {% endif %}
                        </select>
                    </div>
                    
                    <!-- View Mode -->
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Mode</label>
                        <select id="viewMode" class="w-full px-4 py-2.5 border border-gray-300 rounded-lg smooth-transition focus:ring-2 focus:ring-blue-500 focus:border-blue-500 font-medium">
                            <option value="minute" {% if view_mode == 'minute' %}selected{% endif %}>15-min</option>
                            <option value="hourly" {% if view_mode == 'hourly' %}selected{% endif %}>Hourly</option>
                            <option value="daily" {% if view_mode == 'daily' %}selected{% endif %}>Daily</option>
                            <option value="weekly" {% if view_mode == 'weekly' %}selected{% endif %}>Weekly</option>
                            <option value="monthly" {% if view_mode == 'monthly' %}selected{% endif %}>Monthly</option>
                            <option value="yearly" {% if view_mode == 'yearly' %}selected{% endif %}>Yearly</option>
                        </select>
                    </div>

                    <!-- Period (Days) -->
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Period (Days)</label>
                        <select id="periodDays" class="w-full px-4 py-2.5 border border-gray-300 rounded-lg smooth-transition focus:ring-2 focus:ring-blue-500 focus:border-blue-500 font-medium">
                            <option value="1" {% if days == 1 %}selected{% endif %}>Last 1 day</option>
                            <option value="3" {% if days == 3 %}selected{% endif %}>Last 3 days</option>
                            <option value="7" {% if days == 7 %}selected{% endif %}>Last 7 days</option>
                            <option value="14" {% if days == 14 %}selected{% endif %}>Last 14 days</option>
                            <option value="30" {% if days == 30 %}selected{% endif %}>Last 30 days</option>
                            <option value="60" {% if days == 60 %}selected{% endif %}>Last 60 days</option>
                            <option value="90" {% if days == 90 %}selected{% endif %}>Last 90 days</option>
                            <option value="180" {% if days == 180 %}selected{% endif %}>Last 180 days</option>
                            <option value="365" {% if days == 365 %}selected{% endif %}>Last 365 days</option>
                        </select>
                    </div>

                    <!-- Show URLs Checkbox (Client-side only) -->
                    <div class="flex items-end">
                        <label class="flex items-center space-x-3 cursor-pointer bg-white px-4 py-2.5 rounded-lg border border-gray-300 hover:bg-blue-50 smooth-transition w-full">
                            <input type="checkbox" id="showUrls" class="w-5 h-5 text-blue-600 rounded focus:ring-2 focus:ring-blue-500" onchange="toggleUrlColumns()">
                            <span class="text-sm font-semibold text-gray-700 flex items-center">
                                <svg class="w-4 h-4 mr-1 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"/>
                                </svg>
                                Show URLs
                            </span>
                        </label>
                    </div>
                </div>

                <!-- Primary Controls Apply Button -->
                <div class="mt-4">
                    <button type="button" onclick="updatePrimaryControls()" class="px-6 py-2.5 bg-gradient-to-r from-blue-600 to-indigo-600 text-white font-semibold rounded-lg hover:from-blue-700 hover:to-indigo-700 smooth-transition shadow-md hover:shadow-lg transform hover:scale-[1.02] flex items-center">
                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                        </svg>
                        Apply
                    </button>
                </div>
            </div>

            <!-- Advanced Filters Form (POST) -->
            <form method="POST" action="/dashboard" id="filterForm">

                <!-- Advanced Filters (Collapsible) -->
                <details class="mb-6">
                    <summary class="cursor-pointer glass rounded-2xl p-4 mb-4 hover:shadow-lg smooth-transition border border-blue-100">
                        <span class="text-sm font-bold bg-gradient-to-r from-blue-600 to-cyan-600 bg-clip-text text-transparent flex items-center">
                            <svg class="w-5 h-5 mr-2 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4"/>
                            </svg>
                            <span class="text-gray-700">üîç Advanced Filters</span>
                            <span class="text-xs font-normal text-gray-500 ml-2">(Date, Time, Speed Range)</span>
                        </span>
                    </summary>
                    
                    <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4 glass rounded-2xl p-6 mt-2 border border-blue-100">
                        <!-- Date From -->
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">üìÖ Date From</label>
                            <input type="date" name="date_from" id="dateFrom" value="{{ date_from }}" class="w-full px-3 py-2.5 text-sm border border-gray-300 rounded-lg smooth-transition focus:ring-2 focus:ring-blue-500 focus:border-blue-500 hover:border-blue-400 bg-white shadow-sm">
                        </div>

                        <!-- Date To -->
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">üìÖ Date To</label>
                            <input type="date" name="date_to" id="dateTo" value="{{ date_to }}" class="w-full px-3 py-2.5 text-sm border border-gray-300 rounded-lg smooth-transition focus:ring-2 focus:ring-blue-500 focus:border-blue-500 hover:border-blue-400 bg-white shadow-sm">
                        </div>

                        <!-- Time From -->
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">üïê Time From</label>
                            <input type="time" name="time_from" id="timeFrom" value="{{ time_from }}" class="w-full px-3 py-2.5 text-sm border border-gray-300 rounded-lg smooth-transition focus:ring-2 focus:ring-blue-500 focus:border-blue-500 hover:border-blue-400 bg-white shadow-sm">
                        </div>

                        <!-- Time To -->
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">üïê Time To</label>
                            <input type="time" name="time_to" id="timeTo" value="{{ time_to }}" class="w-full px-3 py-2.5 text-sm border border-gray-300 rounded-lg smooth-transition focus:ring-2 focus:ring-blue-500 focus:border-blue-500 hover:border-blue-400 bg-white shadow-sm">
                        </div>

                        <!-- Min Download -->
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">‚¨áÔ∏è Min Download</label>
                            <input type="number" name="min_download" id="minDownload" value="{{ min_download }}" step="0.1" placeholder="0" class="w-full px-3 py-2.5 text-sm border border-gray-300 rounded-lg smooth-transition focus:ring-2 focus:ring-blue-500 focus:border-blue-500 hover:border-blue-400 bg-white shadow-sm">
                        </div>

                        <!-- Max Download -->
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">‚¨áÔ∏è Max Download</label>
                            <input type="number" name="max_download" id="maxDownload" value="{{ max_download }}" step="0.1" placeholder="1000" class="w-full px-3 py-2.5 text-sm border border-gray-300 rounded-lg smooth-transition focus:ring-2 focus:ring-blue-500 focus:border-blue-500 hover:border-blue-400 bg-white shadow-sm">
                        </div>

                        <!-- Min Upload -->
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">‚¨ÜÔ∏è Min Upload</label>
                            <input type="number" name="min_upload" id="minUpload" value="{{ min_upload }}" step="0.1" placeholder="0" class="w-full px-3 py-2.5 text-sm border border-gray-300 rounded-lg smooth-transition focus:ring-2 focus:ring-blue-500 focus:border-blue-500 hover:border-blue-400 bg-white shadow-sm">
                        </div>

                        <!-- Max Upload -->
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">‚¨ÜÔ∏è Max Upload</label>
                            <input type="number" name="max_upload" id="maxUpload" value="{{ max_upload }}" step="0.1" placeholder="1000" class="w-full px-3 py-2.5 text-sm border border-gray-300 rounded-lg smooth-transition focus:ring-2 focus:ring-blue-500 focus:border-blue-500 hover:border-blue-400 bg-white shadow-sm">
                        </div>

                        <!-- Connection Type -->
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">üì° Connection</label>
                            <select name="connection_type" id="connectionType" class="w-full px-3 py-2.5 text-sm border border-gray-300 rounded-lg smooth-transition focus:ring-2 focus:ring-blue-500 focus:border-blue-500 hover:border-blue-400 bg-white shadow-sm">
                                <option value="">All Types</option>
                                <option value="wifi" {% if connection_type == 'wifi' %}selected{% endif %}>WiFi</option>
                                <option value="ethernet" {% if connection_type == 'ethernet' %}selected{% endif %}>Ethernet</option>
                                <option value="mobile" {% if connection_type == 'mobile' %}selected{% endif %}>Mobile</option>
                            </select>
                        </div>

                        <!-- ISP -->
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">üåê ISP</label>
                            <input type="text" name="isp" id="ispFilter" value="{{ isp }}" placeholder="All ISPs" class="w-full px-3 py-2.5 text-sm border border-gray-300 rounded-lg smooth-transition focus:ring-2 focus:ring-blue-500 focus:border-blue-500 hover:border-blue-400 bg-white shadow-sm">
                        </div>

                        <!-- Min Ping -->
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">üì∂ Min Ping (ms)</label>
                            <input type="number" name="min_ping" id="minPing" value="{{ min_ping }}" step="0.1" placeholder="0" class="w-full px-3 py-2.5 text-sm border border-gray-300 rounded-lg smooth-transition focus:ring-2 focus:ring-blue-500 focus:border-blue-500 hover:border-blue-400 bg-white shadow-sm">
                        </div>

                        <!-- Max Ping -->
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">üì∂ Max Ping (ms)</label>
                            <input type="number" name="max_ping" id="maxPing" value="{{ max_ping }}" step="0.1" placeholder="1000" class="w-full px-3 py-2.5 text-sm border border-gray-300 rounded-lg smooth-transition focus:ring-2 focus:ring-blue-500 focus:border-blue-500 hover:border-blue-400 bg-white shadow-sm">
                        </div>

                    <!-- Apply Button -->
                    <div class="flex items-end col-span-2 md:col-span-3 lg:col-span-4">
                        <button type="submit" class="w-full px-8 py-3.5 bg-gradient-to-r from-blue-600 to-cyan-500 text-white font-bold rounded-xl hover:from-blue-700 hover:to-cyan-600 smooth-transition shadow-lg hover:shadow-xl transform hover:scale-[1.02] flex items-center justify-center">
                            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z"/>
                            </svg>
                            Apply Advanced Filters
                        </button>
                    </div>
                </div>
            </form>
        </div>

        <!-- Charts Section -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
            <!-- Download/Upload Chart -->
            <div class="glass rounded-2xl p-6 smooth-transition hover-lift">
                <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                    <svg class="w-5 h-5 mr-2 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 12l3-3 3 3 4-4M8 21l4-4 4 4M3 4h18M4 4h16v12a1 1 0 01-1 1H5a1 1 0 01-1-1V4z"/>
                    </svg>
                    Download & Upload Speed
                </h3>
                <div id="speedChart" class="chart-container"></div>
            </div>

            <!-- Ping Chart -->
            <div class="glass rounded-2xl p-6 smooth-transition hover-lift">
                <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                    <svg class="w-5 h-5 mr-2 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"/>
                    </svg>
                    Ping Latency
                </h3>
                <div id="pingChart" class="chart-container"></div>
            </div>
        </div>

        <!-- Connection Type Comparison Chart -->
        <div class="glass rounded-2xl p-6 mb-8 smooth-transition">
            <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                <svg class="w-6 h-6 mr-2 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
                </svg>
                üì° Performance by Connection Type <span class="text-sm font-normal text-gray-500 ml-2">(Download & Upload Comparison)</span>
            </h3>
            <div id="connectionTypeChart" style="height: 450px;"></div>
        </div>

        <!-- Data Table -->
        <div class="glass rounded-2xl p-6 smooth-transition">
            <div class="flex items-center justify-between mb-6">
                <h2 class="text-2xl font-bold text-gray-800 flex items-center">
                    <svg class="w-6 h-6 mr-2 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                    </svg>
                    Speed Test Data
                    <span class="ml-3 px-3 py-1 bg-indigo-100 text-indigo-800 text-sm font-semibold rounded-full pulse-subtle">
                        {{ data|length }} records
                    </span>
                </h2>
                <div class="flex items-center space-x-3">
                    <button onclick="toggleTableCollapse()" id="collapseToggleBtn" class="px-4 py-2 bg-indigo-500 text-white rounded-lg hover:bg-indigo-600 smooth-transition shadow-md hover:shadow-lg flex items-center" title="Collapse/Expand Table">
                        <svg id="collapseIcon" class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7"/>
                        </svg>
                        <span id="collapseText">Collapse</span>
                    </button>
                    <button onclick="exportToCSV()" class="px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 smooth-transition shadow-md hover:shadow-lg flex items-center">
                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                        </svg>
                        Export CSV
                    </button>
                </div>
            </div>

            <!-- Collapsible Table Content -->
            <div id="tableContent" class="smooth-transition" style="max-height: none; overflow: hidden;">
                <!-- Table Connection Filter -->
                <div class="mb-4 bg-gradient-to-r from-blue-50 to-cyan-50 rounded-lg p-4 border border-blue-200">
                <div class="flex items-center justify-between mb-3">
                    <label class="text-sm font-semibold text-gray-700 flex items-center">
                        <svg class="w-4 h-4 mr-2 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z"/>
                        </svg>
                        üìã Table Connection Filter:
                    </label>
                    <div class="text-sm text-gray-600">
                        <span id="visibleRows">{{ data|length }}</span> / {{ data|length }} rows visible
                    </div>
                </div>
                <div class="flex flex-wrap gap-4">
                    <label class="flex items-center space-x-2 cursor-pointer">
                        <input type="checkbox" value="Wi-Fi 5GHz" class="connection-filter w-4 h-4 text-blue-600 rounded focus:ring-2 focus:ring-blue-500" onchange="filterTableByConnection()">
                        <span class="text-sm text-gray-700">Wi-Fi 5GHz</span>
                    </label>
                    <label class="flex items-center space-x-2 cursor-pointer">
                        <input type="checkbox" value="Wi-Fi 2.4GHz" class="connection-filter w-4 h-4 text-blue-600 rounded focus:ring-2 focus:ring-blue-500" onchange="filterTableByConnection()">
                        <span class="text-sm text-gray-700">Wi-Fi 2.4GHz</span>
                    </label>
                    <label class="flex items-center space-x-2 cursor-pointer">
                        <input type="checkbox" value="Ethernet" class="connection-filter w-4 h-4 text-blue-600 rounded focus:ring-2 focus:ring-blue-500" onchange="filterTableByConnection()">
                        <span class="text-sm text-gray-700">Ethernet</span>
                    </label>
                    <label class="flex items-center space-x-2 cursor-pointer">
                        <input type="checkbox" value="Unknown" class="connection-filter w-4 h-4 text-blue-600 rounded focus:ring-2 focus:ring-blue-500" onchange="filterTableByConnection()">
                        <span class="text-sm text-gray-700">Unknown</span>
                    </label>
                    <button onclick="clearConnectionFilters()" class="ml-4 px-3 py-1 text-xs bg-white border border-blue-300 text-blue-700 rounded-lg hover:bg-blue-50 smooth-transition">
                        Clear All
                    </button>
                </div>
            </div>

            <div class="overflow-x-auto rounded-lg">
                <table class="data-table" id="dataTable">
                    <thead>
                        <tr>
                            <th class="cursor-pointer hover:bg-indigo-700 smooth-transition" onclick="sortTable(0)">
                                Timestamp 
                                <svg class="w-4 h-4 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16V4m0 0L3 8m4-4l4 4m6 0v12m0 0l4-4m-4 4l-4-4"/>
                                </svg>
                            </th>
                            <th class="cursor-pointer hover:bg-indigo-700 smooth-transition" onclick="sortTable(1)">
                                Download (Mbps)
                                <svg class="w-4 h-4 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16V4m0 0L3 8m4-4l4 4m6 0v12m0 0l4-4m-4 4l-4-4"/>
                                </svg>
                            </th>
                            <th class="cursor-pointer hover:bg-indigo-700 smooth-transition" onclick="sortTable(2)">
                                Upload (Mbps)
                                <svg class="w-4 h-4 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16V4m0 0L3 8m4-4l4 4m6 0v12m0 0l4-4m-4 4l-4-4"/>
                                </svg>
                            </th>
                            <th class="cursor-pointer hover:bg-indigo-700 smooth-transition" onclick="sortTable(3)">
                                Ping (ms)
                                <svg class="w-4 h-4 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16V4m0 0L3 8m4-4l4 4m6 0v12m0 0l4-4m-4 4l-4-4"/>
                                </svg>
                            </th>
                            <th>Server</th>
                            <th>Public IP</th>
                            <th>Connection</th>
                            <th class="url-column" style="display: none;">Result URLs</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for record in data %}
                        <tr class="smooth-transition">
                            <td class="font-medium text-gray-900">{{ record.date_ist_str or record.date_ist }}</td>
                            <td>
                                <span class="badge bg-indigo-100 text-indigo-800">
                                    {{ "%.2f"|format(record.download_avg or 0) }}
                                </span>
                            </td>
                            <td>
                                <span class="badge bg-purple-100 text-purple-800">
                                    {{ "%.2f"|format(record.upload_avg or 0) }}
                                </span>
                            </td>
                            <td>
                                {% set ping_val = record.ping_avg or 0 %}
                                {% if ping_val < 20 %}
                                <span class="badge bg-green-100 text-green-800" title="Excellent - Low latency">
                                    {{ "%.2f"|format(ping_val) }}
                                </span>
                                {% elif ping_val < 50 %}
                                <span class="badge bg-yellow-100 text-yellow-800" title="Good - Moderate latency">
                                    {{ "%.2f"|format(ping_val) }}
                                </span>
                                {% elif ping_val < 100 %}
                                <span class="badge bg-orange-100 text-orange-800" title="Fair - Higher latency">
                                    {{ "%.2f"|format(ping_val) }}
                                </span>
                                {% else %}
                                <span class="badge bg-red-100 text-red-800" title="Poor - High latency">
                                    {{ "%.2f"|format(ping_val) }}
                                </span>
                                {% endif %}
                            </td>
                            <td class="text-gray-600">{{ record.top_server or 'N/A' }}</td>
                            <td class="text-gray-600">{{ record.public_ip or 'N/A' }}</td>
                            <td>
                                {% set conn_type = record.connection_type or 'Unknown' %}
                                {% if conn_type == 'Wi-Fi (unknown band)' %}
                                <span class="badge bg-gray-100 text-gray-600">
                                    <svg class="w-3 h-3 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                    </svg>
                                    Unknown
                                </span>
                                {% elif conn_type == 'wifi' or 'wifi' in conn_type.lower() %}
                                <span class="badge bg-blue-100 text-blue-800">
                                    <svg class="w-3 h-3 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.111 16.404a5.5 5.5 0 017.778 0M12 20h.01m-7.08-7.071c3.904-3.905 10.236-3.905 14.141 0M1.394 9.393c5.857-5.857 15.355-15.857 21.213 0"/>
                                    </svg>
                                    WiFi
                                </span>
                                {% elif conn_type == 'ethernet' or 'ethernet' in conn_type.lower() %}
                                <span class="badge bg-gray-100 text-gray-800">
                                    <svg class="w-3 h-3 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 12h14M5 12a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v4a2 2 0 01-2 2M5 12a2 2 0 00-2 2v4a2 2 0 002 2h14a2 2 0 002-2v-4a2 2 0 00-2-2m-2-4h.01M17 16h.01"/>
                                    </svg>
                                    Ethernet
                                </span>
                                {% else %}
                                <span class="badge bg-orange-100 text-orange-800">
                                    {{ conn_type }}
                                </span>
                                {% endif %}
                            </td>
                            <td class="url-column" style="display: none;">
                                {% if record.result_urls and record.result_urls|length > 0 %}
                                    {% for url in record.result_urls %}
                                    <a href="{{ url }}" target="_blank" class="inline-flex items-center text-blue-600 hover:text-blue-800 text-xs mr-2 mb-1 smooth-transition">
                                        <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"/>
                                        </svg>
                                        Result #{{ loop.index }}
                                    </a>
                                    {% if not loop.last %}<br>{% endif %}
                                    {% endfor %}
                                {% else %}
                                <span class="text-gray-400 text-xs">No URLs</span>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            </div>
            <!-- End Collapsible Table Content -->
        </div>
    </div>

    <!-- Footer -->
    <footer class="glass-dark mt-12 py-6">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 text-center text-white">
            <p class="text-sm">
                Speed Test Dashboard &copy; 2025 | Developed by <strong>Varadharajan</strong> | 
                <a href="https://github.com/varadharajaan/internet-speed-tester" target="_blank" class="hover:text-indigo-300 smooth-transition font-semibold">
                    <svg class="w-4 h-4 inline-block mr-1" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/>
                    </svg>
                    View on GitHub
                </a>
            </p>
        </div>
    </footer>

    <!-- Chart Modal -->
    <div id="chartModal" class="chart-modal">
        <div class="chart-modal-content">
            <button class="chart-modal-close" onclick="closeChartModal()">‚úï</button>
            <h3 class="chart-modal-title" id="modalChartTitle">Chart View</h3>
            <div id="modalChart" class="chart-modal-chart"></div>
        </div>
    </div>

    <script>
        // Async Loading Configuration
        const ASYNC_MODE = {{ async_mode|default(false)|tojson }};
        const CURRENT_MODE = '{{ mode }}';
        const CURRENT_DAYS = {{ days }};
        
        // Async data loading function
        async function loadDashboardDataAsync() {
            if (!ASYNC_MODE) return;
            
            console.log('Loading dashboard data asynchronously...');
            const startTime = performance.now();
            
            try {
                const url = `/api/dashboard?mode=${CURRENT_MODE}&days=${CURRENT_DAYS}`;
                const response = await fetch(url);
                const data = await response.json();
                
                if (data.success) {
                    const elapsed = ((performance.now() - startTime) / 1000).toFixed(2);
                    console.log(`Dashboard data loaded in ${elapsed}s`);
                    
                    // Update stats cards
                    updateStatsCards(data.stats, data.trends);
                    
                    // Update charts
                    updateChartsWithData(data.chart_data);
                    
                    // Update last updated timestamp
                    document.getElementById('lastUpdate').textContent = data.last_update;
                    
                    // Mark body as data-loaded
                    document.body.classList.add('data-loaded');
                }
            } catch (error) {
                console.error('Failed to load dashboard data:', error);
            }
        }
        
        function updateStatsCards(stats, trends) {
            // Update download stat
            const downloadStat = document.querySelector('[data-stat="download"]');
            if (downloadStat) {
                downloadStat.textContent = stats.avg_download?.toFixed(2) || '0.00';
            }
            
            // Update upload stat
            const uploadStat = document.querySelector('[data-stat="upload"]');
            if (uploadStat) {
                uploadStat.textContent = stats.avg_upload?.toFixed(2) || '0.00';
            }
            
            // Update ping stat
            const pingStat = document.querySelector('[data-stat="ping"]');
            if (pingStat) {
                pingStat.textContent = stats.avg_ping?.toFixed(2) || '0.00';
            }
            
            // Update total tests
            const totalStat = document.querySelector('[data-stat="total"]');
            if (totalStat) {
                totalStat.textContent = stats.total_tests || '0';
            }
        }
        
        function updateChartsWithData(newChartData) {
            // Update global chart data
            if (newChartData) {
                chartData.timestamps = newChartData.timestamps || [];
                chartData.download = newChartData.download || [];
                chartData.upload = newChartData.upload || [];
                chartData.ping = newChartData.ping || [];
                
                // Reinitialize charts with new data
                initSpeedChart();
                initPingChart();
            }
        }
        
        // Initialize async loading on page load
        if (ASYNC_MODE) {
            document.addEventListener('DOMContentLoaded', loadDashboardDataAsync);
        }
        
        // Force Refresh Function - bypasses cache to get latest data
        function forceRefresh() {
            const btn = document.getElementById('refreshBtn');
            const icon = document.getElementById('refreshIcon');
            
            // Add spinning animation
            icon.classList.add('animate-spin');
            btn.disabled = true;
            btn.classList.add('opacity-50');
            
            // Get current URL and add/update refresh parameter
            const url = new URL(window.location.href);
            url.searchParams.set('refresh', '1');
            
            // Navigate to the refreshed URL
            window.location.href = url.toString();
        }
        
        // Add spinning animation style
        const style = document.createElement('style');
        style.textContent = `
            @keyframes spin {
                from { transform: rotate(0deg); }
                to { transform: rotate(360deg); }
            }
            .animate-spin { animation: spin 1s linear infinite; }
        `;
        document.head.appendChild(style);

        // Chart Data Preparation
        const chartData = {{ chart_data|tojson }};
        
        // Initialize Speed Chart (Download + Upload)
        function initSpeedChart() {
            const speedChart = echarts.init(document.getElementById('speedChart'));
            
            // Determine if we have a large dataset
            const isLargeDataset = chartData.timestamps.length > 100;
            
            const option = {
                backgroundColor: 'transparent',
                animation: true,
                tooltip: {
                    trigger: 'axis',
                    axisPointer: {
                        type: 'line',
                        lineStyle: {
                            color: '#6366f1',
                            width: 1,
                            type: 'solid'
                        }
                    },
                    backgroundColor: 'rgba(255, 255, 255, 0.98)',
                    borderColor: '#e5e7eb',
                    borderWidth: 1,
                    textStyle: {
                        color: '#1f2937',
                        fontSize: 12
                    },
                    formatter: function(params) {
                        let result = '<strong>' + params[0].name + '</strong><br/>';
                        params.forEach(param => {
                            result += param.marker + ' ' + param.seriesName + ': <b>' + param.value.toFixed(2) + ' Mbps</b><br/>';
                        });
                        return result;
                    }
                },
                legend: {
                    data: ['Download', 'Upload', '200 Mbps Target'],
                    top: 10,
                    textStyle: {
                        color: '#4b5563',
                        fontSize: 12,
                        fontWeight: 600
                    },
                    itemGap: 15
                },
                grid: {
                    left: '8%',
                    right: '8%',
                    bottom: '8%',
                    top: '15%',
                    containLabel: true
                },
                toolbox: {
                    feature: {
                        dataZoom: {
                            yAxisIndex: 'none',
                            title: {
                                zoom: 'Zoom',
                                back: 'Reset Zoom'
                            }
                        },
                        restore: {
                            title: 'Restore'
                        },
                        saveAsImage: {
                            name: 'speed_chart',
                            pixelRatio: 2,
                            title: 'Save'
                        }
                    },
                    iconStyle: {
                        borderColor: '#667eea'
                    },
                    top: 10,
                    right: 20
                },
                xAxis: {
                    type: 'category',
                    boundaryGap: false,
                    data: chartData.timestamps,
                    axisLine: {
                        lineStyle: {
                            color: '#d1d5db'
                        }
                    },
                    axisLabel: {
                        color: '#6b7280',
                        rotate: 45,
                        fontSize: 10,
                        interval: function(index, value) {
                            // Show ~15-20 labels max for readability
                            const totalPoints = chartData.timestamps.length;
                            const interval = Math.ceil(totalPoints / 15);
                            return index % interval === 0;
                        },
                        formatter: function(value) {
                            // Shorten datetime format: "2025-12-29 14:30" -> "12/29 14:30"
                            if (value && value.length > 10) {
                                const parts = value.split(' ');
                                const datePart = parts[0];
                                const timePart = parts[1] || '';
                                const dateMatch = datePart.match(/\d{4}-(\d{2})-(\d{2})/);
                                if (dateMatch) {
                                    return dateMatch[1] + '/' + dateMatch[2] + (timePart ? ' ' + timePart : '');
                                }
                            }
                            return value;
                        }
                    }
                },
                yAxis: {
                    type: 'value',
                    name: 'Speed (Mbps)',
                    nameTextStyle: {
                        color: '#6b7280',
                        fontSize: 12,
                        fontWeight: 600
                    },
                    axisLine: {
                        show: true,
                        lineStyle: {
                            color: '#d1d5db'
                        }
                    },
                    axisLabel: {
                        color: '#6b7280',
                        fontSize: 11
                    },
                    splitLine: {
                        lineStyle: {
                            color: '#f3f4f6',
                            type: 'dashed'
                        }
                    }
                },
                series: [
                    {
                        name: 'Download',
                        type: 'line',
                        smooth: 0.3,
                        symbol: isLargeDataset ? 'none' : 'circle',
                        symbolSize: 4,
                        sampling: 'lttb', // Use Largest-Triangle-Three-Buckets algorithm for downsampling
                        itemStyle: {
                            color: '#3b82f6'
                        },
                        lineStyle: {
                            width: 2,
                            color: '#3b82f6'
                        },
                        emphasis: {
                            focus: 'series',
                            lineStyle: {
                                width: 3
                            }
                        },
                        data: chartData.download,
                        markLine: {
                            silent: true,
                            symbol: 'none',
                            lineStyle: {
                                color: '#10b981',
                                type: 'solid',
                                width: 2,
                                opacity: 0.8
                            },
                            label: {
                                show: true,
                                position: 'insideEndTop',
                                formatter: '200 Mbps',
                                color: '#10b981',
                                fontSize: 11,
                                fontWeight: 'bold',
                                backgroundColor: 'rgba(255, 255, 255, 0.9)',
                                padding: [2, 4],
                                borderRadius: 3
                            },
                            data: [
                                {
                                    yAxis: 200,
                                    name: '200 Mbps Target'
                                },
                                {
                                    type: 'average',
                                    name: 'Avg Download',
                                    lineStyle: {
                                        color: '#3b82f6',
                                        type: 'dashed',
                                        width: 1.5,
                                        opacity: 0.7
                                    },
                                    label: {
                                        show: true,
                                        formatter: function(params) {
                                            return 'Avg: ' + params.value.toFixed(2);
                                        },
                                        position: 'insideEndBottom',
                                        color: '#3b82f6',
                                        fontSize: 10,
                                        fontWeight: 'bold',
                                        backgroundColor: 'rgba(255, 255, 255, 0.9)',
                                        padding: [2, 4],
                                        borderRadius: 3
                                    }
                                }
                            ]
                        }
                    },
                    {
                        name: 'Upload',
                        type: 'line',
                        smooth: 0.3,
                        symbol: isLargeDataset ? 'none' : 'circle',
                        symbolSize: 4,
                        sampling: 'lttb',
                        itemStyle: {
                            color: '#8b5cf6'
                        },
                        lineStyle: {
                            width: 2,
                            color: '#8b5cf6'
                        },
                        emphasis: {
                            focus: 'series',
                            lineStyle: {
                                width: 3
                            }
                        },
                        data: chartData.upload,
                        markLine: {
                            silent: true,
                            symbol: 'none',
                            lineStyle: {
                                color: '#8b5cf6',
                                type: 'dashed',
                                width: 1.5,
                                opacity: 0.7
                            },
                            data: [{
                                type: 'average',
                                name: 'Avg Upload',
                                label: {
                                    show: true,
                                    formatter: function(params) {
                                        return 'Avg: ' + params.value.toFixed(2);
                                    },
                                    position: 'insideEndBottom',
                                    color: '#8b5cf6',
                                    fontSize: 10,
                                    fontWeight: 'bold',
                                    backgroundColor: 'rgba(255, 255, 255, 0.9)',
                                    padding: [2, 4],
                                    borderRadius: 3
                                }
                            }]
                        }
                    }
                ],
                dataZoom: [
                    {
                        type: 'inside',
                        start: 0,
                        end: 100,
                        zoomOnMouseWheel: true,
                        moveOnMouseMove: true
                    },
                    {
                        type: 'slider',
                        show: isLargeDataset,
                        start: 0,
                        end: 100,
                        height: 20,
                        bottom: 10,
                        handleIcon: 'path://M10.7,11.9v-1.3H9.3v1.3c-4.9,0.3-8.8,4.4-8.8,9.4c0,5,3.9,9.1,8.8,9.4v1.3h1.4v-1.3c4.9-0.3,8.8-4.4,8.8-9.4C19.5,16.3,15.6,12.2,10.7,11.9z',
                        handleSize: '80%',
                        handleStyle: {
                            color: '#667eea'
                        },
                        textStyle: {
                            color: '#6b7280'
                        },
                        borderColor: '#e5e7eb'
                    }
                ]
            };
            
            speedChart.setOption(option);
            speedChartInstance = speedChart; // Store instance
            
            // Responsive resize
            window.addEventListener('resize', () => speedChart.resize());
        }

        // Initialize Ping Chart
        function initPingChart() {
            const pingChart = echarts.init(document.getElementById('pingChart'));
            
            const isLargeDataset = chartData.timestamps.length > 100;
            
            const option = {
                backgroundColor: 'transparent',
                animation: true,
                tooltip: {
                    trigger: 'axis',
                    axisPointer: {
                        type: 'line',
                        lineStyle: {
                            color: '#10b981',
                            width: 1,
                            type: 'solid'
                        }
                    },
                    backgroundColor: 'rgba(255, 255, 255, 0.98)',
                    borderColor: '#e5e7eb',
                    borderWidth: 1,
                    textStyle: {
                        color: '#1f2937',
                        fontSize: 12
                    },
                    formatter: function(params) {
                        return '<strong>' + params[0].name + '</strong><br/>' + 
                               params[0].marker + ' Ping: <b>' + params[0].value.toFixed(2) + ' ms</b>';
                    }
                },
                legend: {
                    data: ['Ping', '15ms Target'],
                    top: 10,
                    textStyle: {
                        color: '#4b5563',
                        fontSize: 12,
                        fontWeight: 600
                    },
                    itemGap: 15
                },
                grid: {
                    left: '8%',
                    right: '8%',
                    bottom: '8%',
                    top: '15%',
                    containLabel: true
                },
                toolbox: {
                    feature: {
                        dataZoom: {
                            yAxisIndex: 'none',
                            title: {
                                zoom: 'Zoom',
                                back: 'Reset Zoom'
                            }
                        },
                        restore: {
                            title: 'Restore'
                        },
                        saveAsImage: {
                            name: 'ping_chart',
                            pixelRatio: 2,
                            title: 'Save'
                        }
                    },
                    iconStyle: {
                        borderColor: '#10b981'
                    },
                    top: 10,
                    right: 20
                },
                xAxis: {
                    type: 'category',
                    boundaryGap: false,
                    data: chartData.timestamps,
                    axisLine: {
                        show: true,
                        lineStyle: {
                            color: '#d1d5db'
                        }
                    },
                    axisLabel: {
                        color: '#6b7280',
                        rotate: 45,
                        fontSize: 10,
                        interval: function(index, value) {
                            const totalPoints = chartData.timestamps.length;
                            const interval = Math.ceil(totalPoints / 15);
                            return index % interval === 0;
                        },
                        formatter: function(value) {
                            if (value && value.length > 10) {
                                const parts = value.split(' ');
                                const datePart = parts[0];
                                const timePart = parts[1] || '';
                                const dateMatch = datePart.match(/\d{4}-(\d{2})-(\d{2})/);
                                if (dateMatch) {
                                    return dateMatch[1] + '/' + dateMatch[2] + (timePart ? ' ' + timePart : '');
                                }
                            }
                            return value;
                        }
                    }
                },
                yAxis: {
                    type: 'value',
                    name: 'Latency (ms)',
                    nameTextStyle: {
                        color: '#6b7280',
                        fontSize: 12,
                        fontWeight: 600
                    },
                    axisLine: {
                        show: true,
                        lineStyle: {
                            color: '#d1d5db'
                        }
                    },
                    axisLabel: {
                        color: '#6b7280',
                        fontSize: 11
                    },
                    splitLine: {
                        lineStyle: {
                            color: '#f3f4f6',
                            type: 'dashed'
                        }
                    }
                },
                series: [
                    {
                        name: 'Ping',
                        type: 'line',
                        smooth: 0.3,
                        symbol: isLargeDataset ? 'none' : 'circle',
                        symbolSize: 4,
                        sampling: 'lttb',
                        itemStyle: {
                            color: '#10b981'
                        },
                        lineStyle: {
                            width: 2,
                            color: '#10b981'
                        },
                        emphasis: {
                            focus: 'series',
                            lineStyle: {
                                width: 3
                            }
                        },
                        data: chartData.ping,
                        markLine: {
                            silent: true,
                            symbol: 'none',
                            lineStyle: {
                                color: '#10b981',
                                type: 'solid',
                                width: 2,
                                opacity: 0.8
                            },
                            label: {
                                show: true,
                                position: 'insideEndTop',
                                formatter: '< 15ms',
                                color: '#10b981',
                                fontSize: 11,
                                fontWeight: 'bold',
                                backgroundColor: 'rgba(255, 255, 255, 0.9)',
                                padding: [2, 4],
                                borderRadius: 3
                            },
                            data: [
                                {
                                    yAxis: 15,
                                    name: '15ms Target'
                                },
                                {
                                    type: 'average',
                                    name: 'Avg Ping',
                                    lineStyle: {
                                        color: '#10b981',
                                        type: 'dashed',
                                        width: 1.5,
                                        opacity: 0.7
                                    },
                                    label: {
                                        show: true,
                                        formatter: function(params) {
                                            return 'Avg: ' + params.value.toFixed(2) + 'ms';
                                        },
                                        position: 'insideEndBottom',
                                        color: '#10b981',
                                        fontSize: 10,
                                        fontWeight: 'bold',
                                        backgroundColor: 'rgba(255, 255, 255, 0.9)',
                                        padding: [2, 4],
                                        borderRadius: 3
                                    }
                                }
                            ]
                        }
                    }
                ],
                dataZoom: [
                    {
                        type: 'inside',
                        start: 0,
                        end: 100,
                        zoomOnMouseWheel: true,
                        moveOnMouseMove: true
                    },
                    {
                        type: 'slider',
                        show: isLargeDataset,
                        start: 0,
                        end: 100,
                        height: 20,
                        bottom: 10,
                        handleIcon: 'path://M10.7,11.9v-1.3H9.3v1.3c-4.9,0.3-8.8,4.4-8.8,9.4c0,5,3.9,9.1,8.8,9.4v1.3h1.4v-1.3c4.9-0.3,8.8-4.4,8.8-9.4C19.5,16.3,15.6,12.2,10.7,11.9z',
                        handleSize: '80%',
                        handleStyle: {
                            color: '#10b981'
                        },
                        textStyle: {
                            color: '#6b7280'
                        },
                        borderColor: '#e5e7eb'
                    }
                ]
            };
            
            pingChart.setOption(option);
            pingChartInstance = pingChart; // Store instance
            
            // Responsive resize
            window.addEventListener('resize', () => pingChart.resize());
        }

        // Initialize Connection Type Comparison Chart (Combined Download & Upload)
        function initConnectionTypeCharts() {
            const isLargeDataset = chartData.timestamps.length > 100;
            
            // Group data by connection type - use PRIMARY (first) connection only
            const connectionData = {};
            
            chartData.timestamps.forEach((timestamp, index) => {
                const rawConnection = chartData.connection_types ? chartData.connection_types[index] : 'Unknown';
                const connection = rawConnection.split(',')[0].trim();
                
                // Filter out "Wi-Fi (unknown band)"
                if (connection === 'Wi-Fi (unknown band)') {
                    return;
                }
                
                if (!connectionData[connection]) {
                    connectionData[connection] = {
                        download: [],
                        upload: [],
                        timestamps: []
                    };
                }
                connectionData[connection].download.push(chartData.download[index]);
                connectionData[connection].upload.push(chartData.upload[index]);
                connectionData[connection].timestamps.push(timestamp);
            });

            // Professional color palette - more distinct and vibrant
            const colorPalette = {
                'Wi-Fi 2.4GHz': '#ff6b6b',    // Bright coral red
                'Wi-Fi 5GHz': '#4ecdc4',      // Bright teal
                'Ethernet': '#95a5f6',        // Soft blue-purple
                'Unknown': '#a8a29e'          // Warm gray (stone-400)
            };

            function getColorForConnection(connectionType) {
                const conn = connectionType.trim();
                return colorPalette[conn] || '#95a5a6'; // Gray fallback
            }

            const combinedSeries = [];
            const legendData = [];
            const connectionOrder = ['Wi-Fi 2.4GHz', 'Wi-Fi 5GHz', 'Ethernet', 'Unknown'];
            const connectionThresholds = {{ connection_type_thresholds|tojson }};
            
            const sortedConnections = Object.keys(connectionData).sort((a, b) => {
                let indexA = connectionOrder.indexOf(a);
                let indexB = connectionOrder.indexOf(b);
                if (indexA === -1) indexA = 999;
                if (indexB === -1) indexB = 999;
                return indexA - indexB;
            });
            
            sortedConnections.forEach(conn => {
                const connName = conn.charAt(0).toUpperCase() + conn.slice(1);
                const color = getColorForConnection(conn);
                const threshold = connectionThresholds[conn];
                
                legendData.push(connName);
                
                // Download series - Clean solid line
                combinedSeries.push({
                    name: connName,
                    type: 'line',
                    smooth: 0.3,
                    symbol: isLargeDataset ? 'none' : 'circle',
                    symbolSize: 4,
                    sampling: 'lttb',
                    data: connectionData[conn].download,
                    itemStyle: {
                        color: color
                    },
                    lineStyle: {
                        width: isLargeDataset ? 2 : 2.5,
                        type: 'solid',
                        color: color
                    },
                    emphasis: {
                        focus: 'series',
                        lineStyle: {
                            width: 3.5
                        }
                    },
                    markLine: threshold ? {
                        silent: true,
                        symbol: 'none',
                        lineStyle: {
                            color: color,
                            type: 'dashed',
                            width: 1.5,
                            opacity: 0.6
                        },
                        label: {
                            show: !isLargeDataset,
                            formatter: `${threshold}`,
                            position: 'insideEndTop',
                            color: color,
                            fontSize: 10,
                            fontWeight: 'bold',
                            backgroundColor: 'rgba(255, 255, 255, 0.85)',
                            padding: [2, 4],
                            borderRadius: 3
                        },
                        data: [{
                            yAxis: threshold
                        }]
                    } : undefined
                });
                
                // Upload series - Dotted line for distinction
                combinedSeries.push({
                    name: connName,
                    type: 'line',
                    smooth: 0.3,
                    symbol: isLargeDataset ? 'none' : 'emptyCircle',
                    symbolSize: 3,
                    sampling: 'lttb',
                    data: connectionData[conn].upload,
                    itemStyle: {
                        color: color,
                        opacity: 0.8
                    },
                    lineStyle: {
                        width: isLargeDataset ? 1.5 : 2,
                        type: [4, 4], // Dotted pattern
                        color: color,
                        opacity: 0.8
                    },
                    emphasis: {
                        focus: 'series',
                        lineStyle: {
                            width: 3,
                            opacity: 1
                        }
                    }
                });
            });

            const connectionChart = echarts.init(document.getElementById('connectionTypeChart'));
            
            connectionChart.setOption({
                backgroundColor: 'transparent',
                animation: !isLargeDataset,
                tooltip: {
                    trigger: 'axis',
                    backgroundColor: 'rgba(255, 255, 255, 0.98)',
                    borderColor: '#e5e7eb',
                    borderWidth: 1,
                    textStyle: { color: '#1f2937', fontSize: 12 },
                    formatter: function(params) {
                        // Format date: "2025-12-29 14:30" -> "12/29 14:30"
                        let dateStr = params[0].axisValue;
                        if (dateStr && dateStr.length > 10) {
                            const parts = dateStr.split(' ');
                            const datePart = parts[0];
                            const timePart = parts[1] || '';
                            const dateMatch = datePart.match(/\d{4}-(\d{2})-(\d{2})/);
                            if (dateMatch) {
                                dateStr = dateMatch[1] + '/' + dateMatch[2] + (timePart ? ' ' + timePart : '');
                            }
                        }
                        let result = '<strong>' + dateStr + '</strong><br/>';
                        const grouped = {};
                        params.forEach(param => {
                            if (!grouped[param.seriesName]) {
                                grouped[param.seriesName] = { download: null, upload: null };
                            }
                            if (param.seriesIndex % 2 === 0) {
                                grouped[param.seriesName].download = param.value;
                            } else {
                                grouped[param.seriesName].upload = param.value;
                            }
                        });
                        
                        Object.keys(grouped).forEach(connName => {
                            result += '<div style="margin: 4px 0;">';
                            result += '<strong>' + connName + ':</strong><br/>';
                            if (grouped[connName].download !== null) {
                                result += '&nbsp;&nbsp;‚¨áÔ∏è <b>' + grouped[connName].download.toFixed(2) + '</b> Mbps<br/>';
                            }
                            if (grouped[connName].upload !== null) {
                                result += '&nbsp;&nbsp;‚¨ÜÔ∏è <b>' + grouped[connName].upload.toFixed(2) + '</b> Mbps';
                            }
                            result += '</div>';
                        });
                        return result;
                    }
                },
                legend: {
                    data: legendData,
                    top: 10,
                    textStyle: { color: '#4b5563', fontSize: 12, fontWeight: 600 },
                    itemGap: 20
                },
                grid: {
                    left: '8%',
                    right: '8%',
                    bottom: isLargeDataset ? '12%' : '8%',
                    top: '15%',
                    containLabel: true
                },
                toolbox: {
                    feature: {
                        dataZoom: {
                            yAxisIndex: 'none',
                            title: { zoom: 'Zoom', back: 'Reset' }
                        },
                        restore: { title: 'Restore' },
                        saveAsImage: {
                            name: 'connection_comparison',
                            pixelRatio: 2,
                            title: 'Save'
                        }
                    },
                    iconStyle: {
                        borderColor: '#667eea'
                    },
                    top: 10,
                    right: 20
                },
                xAxis: {
                    type: 'category',
                    boundaryGap: false,
                    data: chartData.timestamps,
                    axisLine: { lineStyle: { color: '#d1d5db' } },
                    axisLabel: { 
                        color: '#6b7280', 
                        rotate: 45, 
                        fontSize: 10,
                        interval: isLargeDataset ? 'auto' : function(index, value) {
                            // Show ~15-20 labels max for readability
                            const totalPoints = chartData.timestamps.length;
                            const interval = Math.ceil(totalPoints / 15);
                            return index % interval === 0;
                        },
                        formatter: function(value) {
                            // Shorten datetime format: "2025-12-29 14:30" -> "12/29 14:30"
                            if (value && value.length > 10) {
                                const parts = value.split(' ');
                                const datePart = parts[0];
                                const timePart = parts[1] || '';
                                const dateMatch = datePart.match(/\d{4}-(\d{2})-(\d{2})/);
                                if (dateMatch) {
                                    return dateMatch[1] + '/' + dateMatch[2] + (timePart ? ' ' + timePart : '');
                                }
                            }
                            return value;
                        }
                    }
                },
                yAxis: {
                    type: 'value',
                    name: 'Speed (Mbps)',
                    nameTextStyle: { color: '#6b7280', fontSize: 12, fontWeight: 600 },
                    axisLine: { show: true, lineStyle: { color: '#d1d5db' } },
                    axisLabel: { color: '#6b7280', fontSize: 11 },
                    splitLine: { lineStyle: { color: '#f3f4f6', type: 'dashed' } }
                },
                series: combinedSeries,
                dataZoom: [
                    {
                        type: 'inside',
                        start: 0,
                        end: 100,
                        zoomOnMouseWheel: true,
                        moveOnMouseMove: true
                    },
                    {
                        type: 'slider',
                        show: isLargeDataset,
                        start: 0,
                        end: 100,
                        height: 20,
                        bottom: 10,
                        handleIcon: 'path://M10.7,11.9v-1.3H9.3v1.3c-4.9,0.3-8.8,4.4-8.8,9.4c0,5,3.9,9.1,8.8,9.4v1.3h1.4v-1.3c4.9-0.3,8.8-4.4,8.8-9.4C19.5,16.3,15.6,12.2,10.7,11.9z',
                        handleSize: '80%',
                        handleStyle: { color: '#667eea' },
                        textStyle: { color: '#6b7280' },
                        borderColor: '#e5e7eb'
                    }
                ]
            });

            connectionChartInstance = connectionChart;
            window.addEventListener('resize', () => connectionChart.resize());
        }

        // Open chart in modal (fullscreen)
        function openChartModal(chartType, title) {
            const modal = document.getElementById('chartModal');
            const modalChartDiv = document.getElementById('modalChart');
            const modalTitle = document.getElementById('modalChartTitle');
            
            // Set title
            modalTitle.textContent = title;
            
            // Show modal
            modal.classList.add('active');
            
            // Dispose previous modal chart if exists
            if (modalChartInstance) {
                modalChartInstance.dispose();
            }
            
            // Initialize new chart in modal
            modalChartInstance = echarts.init(modalChartDiv);
            
            // Get option from the corresponding chart
            let option = null;
            if (chartType === 'speed') {
                option = speedChartInstance.getOption();
            } else if (chartType === 'ping') {
                option = pingChartInstance.getOption();
            } else if (chartType === 'connection') {
                option = connectionChartInstance.getOption();
            }
            
            // Set option to modal chart
            if (option) {
                modalChartInstance.setOption(option);
            }
            
            // Resize after a short delay to ensure proper rendering
            setTimeout(() => {
                modalChartInstance.resize();
            }, 100);
            
            // Prevent body scroll when modal is open
            document.body.style.overflow = 'hidden';
        }

        // Close chart modal
        function closeChartModal() {
            const modal = document.getElementById('chartModal');
            modal.classList.remove('active');
            
            // Dispose modal chart
            if (modalChartInstance) {
                modalChartInstance.dispose();
                modalChartInstance = null;
            }
            
            // Restore body scroll
            document.body.style.overflow = '';
        }

        // Global variables to store chart instances
        let speedChartInstance = null;
        let pingChartInstance = null;
        let connectionChartInstance = null;
        let modalChartInstance = null;

        // Initialize charts on page load
        document.addEventListener('DOMContentLoaded', function() {
            initSpeedChart();
            initPingChart();
            initConnectionTypeCharts();
            updatePeriodLabel(); // Initialize period label
            
            // Add event listener for view mode changes
            document.getElementById('viewMode').addEventListener('change', updatePeriodLabel);
            
            // Add click listeners to charts for modal
            document.getElementById('speedChart').addEventListener('click', function() {
                openChartModal('speed', 'Download & Upload Speed');
            });
            
            document.getElementById('pingChart').addEventListener('click', function() {
                openChartModal('ping', 'Ping Latency');
            });
            
            document.getElementById('connectionTypeChart').addEventListener('click', function() {
                openChartModal('connection', 'Performance by Connection Type');
            });
            
            // Close modal on background click
            document.getElementById('chartModal').addEventListener('click', function(e) {
                if (e.target.id === 'chartModal') {
                    closeChartModal();
                }
            });
            
            // Close modal on ESC key
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    closeChartModal();
                }
            });
        });

        // Update period label and options based on view mode
        function updatePeriodLabel() {
            const viewMode = document.getElementById('viewMode').value;
            const periodLabel = document.querySelector('label[for="periodDays"]');
            const periodSelect = document.getElementById('periodDays');
            const currentValue = periodSelect.value;
            
            // Define label text for each mode
            const labelText = {
                'minute': 'Period (Days)',
                'hourly': 'Period (Days)',
                'daily': 'Period (Days)',
                'weekly': 'Period (Weeks)',
                'monthly': 'Period (Months)',
                'yearly': 'Period (Years)'
            };
            
            // Define options for each mode
            const modeOptions = {
                'minute': [
                    { value: 1, text: 'Last 1 day' },
                    { value: 3, text: 'Last 3 days' },
                    { value: 7, text: 'Last 7 days' },
                    { value: 14, text: 'Last 14 days' },
                    { value: 30, text: 'Last 30 days' }
                ],
                'hourly': [
                    { value: 1, text: 'Last 1 day' },
                    { value: 3, text: 'Last 3 days' },
                    { value: 7, text: 'Last 7 days' },
                    { value: 14, text: 'Last 14 days' },
                    { value: 30, text: 'Last 30 days' },
                    { value: 90, text: 'Last 90 days' }
                ],
                'daily': [
                    { value: 7, text: 'Last 7 days' },
                    { value: 14, text: 'Last 14 days' },
                    { value: 30, text: 'Last 30 days' },
                    { value: 60, text: 'Last 60 days' },
                    { value: 90, text: 'Last 90 days' },
                    { value: 180, text: 'Last 180 days' },
                    { value: 365, text: 'Last 365 days' }
                ],
                'weekly': [
                    { value: 4, text: 'Last 4 weeks' },
                    { value: 8, text: 'Last 8 weeks' },
                    { value: 12, text: 'Last 12 weeks' },
                    { value: 26, text: 'Last 26 weeks' },
                    { value: 52, text: 'Last 52 weeks' }
                ],
                'monthly': [
                    { value: 3, text: 'Last 3 months' },
                    { value: 6, text: 'Last 6 months' },
                    { value: 12, text: 'Last 12 months' },
                    { value: 24, text: 'Last 24 months' },
                    { value: 36, text: 'Last 36 months' }
                ],
                'yearly': [
                    { value: 1, text: 'Last 1 year' },
                    { value: 2, text: 'Last 2 years' },
                    { value: 3, text: 'Last 3 years' },
                    { value: 5, text: 'Last 5 years' },
                    { value: 10, text: 'Last 10 years' }
                ]
            };
            
            // Update the label text
            if (periodLabel && labelText[viewMode]) {
                periodLabel.textContent = labelText[viewMode];
            }
            
            // Update dropdown options
            if (periodSelect && modeOptions[viewMode]) {
                const options = modeOptions[viewMode];
                periodSelect.innerHTML = '';
                
                let hasCurrentValue = false;
                options.forEach(opt => {
                    const option = document.createElement('option');
                    option.value = opt.value;
                    option.textContent = opt.text;
                    if (opt.value == currentValue) {
                        option.selected = true;
                        hasCurrentValue = true;
                    }
                    periodSelect.appendChild(option);
                });
                
                // If current value not in new options, select the first one
                if (!hasCurrentValue && options.length > 0) {
                    periodSelect.options[0].selected = true;
                }
            }
        }

        // Reset Filters Function
        function resetFilters() {
            window.location.href = '/dashboard';
        }

        // Quick Filter Function (Client-side only - No server reload!)
        function applyQuickFilter(filterType, value) {
            const table = document.getElementById('dataTable');
            const tbody = table.querySelector('tbody');
            const rows = Array.from(tbody.querySelectorAll('tr'));
            
            // Reset all rows to visible first
            rows.forEach(row => row.style.display = '');
            
            // Apply filter based on type
            rows.forEach(row => {
                const cells = row.cells;
                let shouldHide = false;
                
                switch(filterType) {
                    case 'below_threshold':
                        // Column 1 is download speed - use fixed 200 Mbps threshold
                        const downloadText = cells[1]?.textContent.trim();
                        const download = parseFloat(downloadText);
                        if (download >= 200) {
                            shouldHide = true;
                        }
                        break;
                        
                    case 'performance_drops':
                        // Show only rows with download < 100
                        const downloadDropText = cells[1]?.textContent.trim();
                        const downloadDrop = parseFloat(downloadDropText);
                        if (downloadDrop >= 100) {
                            shouldHide = true;
                        }
                        break;
                        
                    case 'high_ping':
                        // Show only rows with ping > 20
                        const pingText = cells[3]?.textContent.trim();
                        const ping = parseFloat(pingText);
                        if (ping <= 20) {
                            shouldHide = true;
                        }
                        break;
                        
                    case 'isp':
                        // Filter by ISP (not implemented in table, would need backend)
                        // For now, show message
                        console.log('ISP filter:', value);
                        // Fall through to use server-side filter
                        document.getElementById('ispFilter').value = value;
                        document.getElementById('filterForm').submit();
                        return;
                        
                    case 'connection':
                        // Column 6 is connection type
                        const connText = cells[6]?.textContent.toLowerCase();
                        if (!connText.includes(value.toLowerCase())) {
                            shouldHide = true;
                        }
                        break;
                }
                
                if (shouldHide) {
                    row.style.display = 'none';
                }
            });
            
            // Scroll to table
            table.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }

        // Toggle URL column visibility (client-side only, no reload)
        function toggleUrlColumns() {
            const checkbox = document.getElementById('showUrls');
            const urlColumns = document.querySelectorAll('.url-column');
            const displayValue = checkbox.checked ? '' : 'none';
            
            urlColumns.forEach(col => {
                col.style.display = displayValue;
            });
            
            // Save preference to localStorage
            localStorage.setItem('showUrls', checkbox.checked);
        }

        // Update URL with primary controls (mode, days, and host) using GET
        function updatePrimaryControls() {
            const mode = document.getElementById('viewMode').value;
            const days = document.getElementById('periodDays').value;
            const host = document.getElementById('hostSelector').value;
            
            // Build URL with query parameters
            let url = `/dashboard?mode=${mode}&days=${days}`;
            if (host) {
                url += `&host=${encodeURIComponent(host)}`;
            }
            
            // Navigate to new URL
            window.location.href = url;
        }

        // Initialize URL column visibility on page load
        document.addEventListener('DOMContentLoaded', function() {
            const showUrls = localStorage.getItem('showUrls') === 'true';
            const checkbox = document.getElementById('showUrls');
            if (checkbox) {
                checkbox.checked = showUrls;
                toggleUrlColumns();
            }
        });

        // Clear Quick Filters (Show all rows)
        function clearQuickFilters() {
            const table = document.getElementById('dataTable');
            const tbody = table.querySelector('tbody');
            const rows = Array.from(tbody.querySelectorAll('tr'));
            
            // Show all rows
            rows.forEach(row => row.style.display = '');
        }

        // Table Sorting
        let sortDirection = {};
        
        function sortTable(columnIndex) {
            const table = document.getElementById('dataTable');
            const tbody = table.querySelector('tbody');
            const rows = Array.from(tbody.querySelectorAll('tr'));
            const headers = table.querySelectorAll('th');
            
            // Initialize to descending if first click
            if (sortDirection[columnIndex] === undefined) {
                sortDirection[columnIndex] = false; // false = descending
            } else {
                sortDirection[columnIndex] = !sortDirection[columnIndex];
            }
            const ascending = sortDirection[columnIndex];
            
            // Update header icons
            headers.forEach((header, idx) => {
                const svg = header.querySelector('svg');
                if (svg && idx === columnIndex) {
                    svg.style.transform = ascending ? 'rotate(180deg)' : 'rotate(0deg)';
                    svg.style.transition = 'transform 0.3s';
                }
            });
            
            rows.sort((a, b) => {
                let aValue = a.cells[columnIndex].textContent.trim();
                let bValue = b.cells[columnIndex].textContent.trim();
                
                // Try to parse as number
                const aNum = parseFloat(aValue);
                const bNum = parseFloat(bValue);
                
                if (!isNaN(aNum) && !isNaN(bNum)) {
                    return ascending ? aNum - bNum : bNum - aNum;
                }
                
                // String comparison (dates and text)
                return ascending ? 
                    aValue.localeCompare(bValue) : 
                    bValue.localeCompare(aValue);
            });
            
            // Rebuild table with animation
            rows.forEach((row, index) => {
                row.style.opacity = '0';
                setTimeout(() => {
                    tbody.appendChild(row);
                    row.style.opacity = '1';
                }, index * 10);
            });
        }

        // Filter Table by Connection Type (Multi-select)
        function filterTableByConnection() {
            const checkboxes = document.querySelectorAll('.connection-filter:checked');
            const selectedFilters = Array.from(checkboxes).map(cb => cb.value.toLowerCase());
            const table = document.getElementById('dataTable');
            const tbody = table.querySelector('tbody');
            const rows = tbody.querySelectorAll('tr');
            let visibleCount = 0;
            
            rows.forEach(row => {
                const connectionCell = row.cells[6]; // Connection is the 7th column (index 6)
                if (connectionCell) {
                    const connectionText = connectionCell.textContent.trim().toLowerCase();
                    
                    // If no filters selected, show all rows
                    if (selectedFilters.length === 0) {
                        row.style.display = '';
                        visibleCount++;
                    } else {
                        // Check if connection text contains ANY of the selected filter values
                        // This handles comma-separated values like "Wi-Fi 5GHz, Wi-Fi 2.4GHz"
                        const matchesFilter = selectedFilters.some(filter => connectionText.includes(filter));
                        
                        if (matchesFilter) {
                            row.style.display = '';
                            visibleCount++;
                        } else {
                            row.style.display = 'none';
                        }
                    }
                }
            });
            
            // Update visible count
            document.getElementById('visibleRows').textContent = visibleCount;
        }

        // Clear all connection filters
        function clearConnectionFilters() {
            const checkboxes = document.querySelectorAll('.connection-filter');
            checkboxes.forEach(cb => cb.checked = false);
            filterTableByConnection();
        }

        // Toggle table collapse/expand
        function toggleTableCollapse() {
            const tableContent = document.getElementById('tableContent');
            const collapseIcon = document.getElementById('collapseIcon');
            const collapseText = document.getElementById('collapseText');
            const collapseBtn = document.getElementById('collapseToggleBtn');
            
            if (tableContent.style.maxHeight === 'none' || tableContent.style.maxHeight === '') {
                // Collapse
                tableContent.style.maxHeight = '0';
                tableContent.style.opacity = '0';
                tableContent.style.marginTop = '0';
                collapseIcon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>';
                collapseText.textContent = 'Expand';
                collapseBtn.classList.remove('bg-indigo-500', 'hover:bg-indigo-600');
                collapseBtn.classList.add('bg-gray-500', 'hover:bg-gray-600');
            } else {
                // Expand
                tableContent.style.maxHeight = 'none';
                tableContent.style.opacity = '1';
                tableContent.style.marginTop = '';
                collapseIcon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7"/>';
                collapseText.textContent = 'Collapse';
                collapseBtn.classList.remove('bg-gray-500', 'hover:bg-gray-600');
                collapseBtn.classList.add('bg-indigo-500', 'hover:bg-indigo-600');
            }
        }

        // Export to CSV (only visible rows)
        function exportToCSV() {
            const table = document.getElementById('dataTable');
            const rows = Array.from(table.querySelectorAll('tr'));
            
            const csv = rows.filter(row => {
                // Include header row or visible data rows
                return row.parentElement.tagName === 'THEAD' || row.style.display !== 'none';
            }).map(row => {
                const cells = Array.from(row.querySelectorAll('th, td'));
                return cells.map(cell => {
                    const text = cell.textContent.trim();
                    return '"' + text.replace(/"/g, '""') + '"';
                }).join(',');
            }).join('\n');
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'speed_test_data_' + new Date().toISOString().split('T')[0] + '.csv';
            a.click();
            window.URL.revokeObjectURL(url);
        }

        // Auto-refresh every 5 minutes (optional)
        // setInterval(() => {
        //     location.reload();
        // }, 300000);
    </script>
</body>
</html>
