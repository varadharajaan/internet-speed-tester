<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Speed Test Dashboard</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Apache ECharts -->
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    
    <style>
        /* Custom Tailwind Configuration */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        * {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        }
        
        /* Gradient Background */
        body {
            background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 50%, #06b6d4 100%);
            min-height: 100vh;
        }
        
        /* Glass-morphism Effect */
        .glass {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }
        
        .glass-dark {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, #3b82f6 0%, #06b6d4 100%);
            border-radius: 10px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(135deg, #2563eb 0%, #0891b2 100%);
        }
        
        /* Smooth Transitions */
        .smooth-transition {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        /* Hover Lift Effect */
        .hover-lift:hover {
            transform: translateY(-4px);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }
        
        /* Pulse Animation */
        @keyframes pulse-subtle {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.8; }
        }
        
        .pulse-subtle {
            animation: pulse-subtle 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        
        /* Chart Container */
        .chart-container {
            height: 400px;
            width: 100%;
        }
        
        /* Badge Styles */
        .badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.875rem;
            font-weight: 600;
        }
        
        /* Input Focus Styles */
        input:focus, select:focus {
            outline: none;
            ring: 2px;
            ring-color: rgba(102, 126, 234, 0.5);
            border-color: #667eea;
        }
        
        /* Table Styles */
        .data-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
        }
        
        .data-table thead {
            background: linear-gradient(135deg, #3b82f6 0%, #06b6d4 100%);
            color: white;
        }
        
        .data-table th {
            padding: 1rem;
            text-align: left;
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        .data-table tbody tr {
            transition: all 0.2s, opacity 0.3s ease;
        }
        
        .data-table tbody tr:hover {
            background-color: rgba(59, 130, 246, 0.05);
            transform: scale(1.01);
        }
        
        .data-table td {
            padding: 0.875rem 1rem;
            border-bottom: 1px solid #e5e7eb;
        }
        
        /* Loading Spinner */
        .spinner {
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 3px solid white;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="antialiased">
    <!-- Navigation Bar -->
    <nav class="glass-dark shadow-lg sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <div class="flex items-center space-x-3">
                    <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
                    </svg>
                    <span class="text-white text-xl font-bold">Speed Test Dashboard</span>
                </div>
                <div class="flex items-center space-x-4">
                    <span class="text-white text-sm">
                        <svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        </svg>
                        Last Updated: <span id="lastUpdate">{{ last_update }}</span>
                    </span>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Stats Cards -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <!-- Download Speed Card -->
            <div class="glass rounded-2xl p-6 smooth-transition hover-lift">
                <div class="flex items-center justify-between">
                    <div class="flex-1">
                        <p class="text-sm font-medium text-gray-600 mb-1">Avg Download</p>
                        <p class="text-3xl font-bold text-indigo-600">{{ "%.2f"|format(stats.avg_download or 0) }}</p>
                        <p class="text-xs text-gray-500 mt-1">Mbps</p>
                        {% if trends and trends.download_change is defined %}
                        <div class="mt-2 flex items-center">
                            {% if trends.download_change > 0 %}
                            <svg class="w-4 h-4 text-green-500 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 10l7-7m0 0l7 7m-7-7v18"/>
                            </svg>
                            <span class="text-xs font-semibold text-green-600">+{{ trends.download_change }}%</span>
                            {% elif trends.download_change < 0 %}
                            <svg class="w-4 h-4 text-red-500 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 14l-7 7m0 0l-7-7m7 7V3"/>
                            </svg>
                            <span class="text-xs font-semibold text-red-600">{{ trends.download_change }}%</span>
                            {% else %}
                            <span class="text-xs font-semibold text-gray-500">No change</span>
                            {% endif %}
                            <span class="text-xs text-gray-400 ml-1">vs prev period</span>
                        </div>
                        {% endif %}
                    </div>
                    <div class="bg-indigo-100 rounded-full p-3">
                        <svg class="w-8 h-8 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M9 19l3 3m0 0l3-3m-3 3V10"/>
                        </svg>
                    </div>
                </div>
            </div>

            <!-- Upload Speed Card -->
            <div class="glass rounded-2xl p-6 smooth-transition hover-lift">
                <div class="flex items-center justify-between">
                    <div class="flex-1">
                        <p class="text-sm font-medium text-gray-600 mb-1">Avg Upload</p>
                        <p class="text-3xl font-bold text-purple-600">{{ "%.2f"|format(stats.avg_upload or 0) }}</p>
                        <p class="text-xs text-gray-500 mt-1">Mbps</p>
                        {% if trends and trends.upload_change is defined %}
                        <div class="mt-2 flex items-center">
                            {% if trends.upload_change > 0 %}
                            <svg class="w-4 h-4 text-green-500 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 10l7-7m0 0l7 7m-7-7v18"/>
                            </svg>
                            <span class="text-xs font-semibold text-green-600">+{{ trends.upload_change }}%</span>
                            {% elif trends.upload_change < 0 %}
                            <svg class="w-4 h-4 text-red-500 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 14l-7 7m0 0l-7-7m7 7V3"/>
                            </svg>
                            <span class="text-xs font-semibold text-red-600">{{ trends.upload_change }}%</span>
                            {% else %}
                            <span class="text-xs font-semibold text-gray-500">No change</span>
                            {% endif %}
                            <span class="text-xs text-gray-400 ml-1">vs prev period</span>
                        </div>
                        {% endif %}
                    </div>
                    <div class="bg-purple-100 rounded-full p-3">
                        <svg class="w-8 h-8 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/>
                        </svg>
                    </div>
                </div>
            </div>

            <!-- Ping Card -->
            <div class="glass rounded-2xl p-6 smooth-transition hover-lift">
                <div class="flex items-center justify-between">
                    <div class="flex-1">
                        <p class="text-sm font-medium text-gray-600 mb-1">Avg Ping <span class="text-xs text-gray-400">(lower is better)</span></p>
                        <p class="text-3xl font-bold text-green-600">{{ "%.2f"|format(stats.avg_ping or 0) }}</p>
                        <p class="text-xs text-gray-500 mt-1">ms</p>
                        {% if trends and trends.ping_change is defined %}
                        <div class="mt-2 flex items-center">
                            {% if trends.ping_change < 0 %}
                            <svg class="w-4 h-4 text-green-500 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 14l-7 7m0 0l-7-7m7 7V3"/>
                            </svg>
                            <span class="text-xs font-semibold text-green-600">{{ trends.ping_change }}% Better</span>
                            {% elif trends.ping_change > 0 %}
                            <svg class="w-4 h-4 text-red-500 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 10l7-7m0 0l7 7m-7-7v18"/>
                            </svg>
                            <span class="text-xs font-semibold text-red-600">+{{ trends.ping_change }}% Worse</span>
                            {% else %}
                            <span class="text-xs font-semibold text-gray-500">No change</span>
                            {% endif %}
                            <span class="text-xs text-gray-400 ml-1">vs prev period</span>
                        </div>
                        {% endif %}
                    </div>
                    <div class="bg-green-100 rounded-full p-3">
                        <svg class="w-8 h-8 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
                        </svg>
                    </div>
                </div>
            </div>

            <!-- Total Tests Card -->
            <div class="glass rounded-2xl p-6 smooth-transition hover-lift">
                <div class="flex items-center justify-between">
                    <div class="flex-1">
                        <p class="text-sm font-medium text-gray-600 mb-1">Total Tests</p>
                        <p class="text-3xl font-bold text-blue-600">{{ stats.total_tests or 0 }}</p>
                        <p class="text-xs text-gray-500 mt-1">completed</p>
                        {% if trends and trends.tests_change is defined %}
                        <div class="mt-2 flex items-center">
                            {% if trends.tests_change > 0 %}
                            <svg class="w-4 h-4 text-green-500 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 10l7-7m0 0l7 7m-7-7v18"/>
                            </svg>
                            <span class="text-xs font-semibold text-green-600">+{{ trends.tests_change }}%</span>
                            {% elif trends.tests_change < 0 %}
                            <svg class="w-4 h-4 text-red-500 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 14l-7 7m0 0l-7-7m7 7V3"/>
                            </svg>
                            <span class="text-xs font-semibold text-red-600">{{ trends.tests_change }}%</span>
                            {% else %}
                            <span class="text-xs font-semibold text-gray-500">No change</span>
                            {% endif %}
                            <span class="text-xs text-gray-400 ml-1">vs prev period</span>
                        </div>
                        {% endif %}
                    </div>
                    <div class="bg-blue-100 rounded-full p-3">
                        <svg class="w-8 h-8 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
                        </svg>
                    </div>
                </div>
            </div>
        </div>

        <!-- Speed Thresholds Info Banner -->
        <div class="glass rounded-2xl p-6 mb-8 smooth-transition border-l-4 border-blue-500">
            <h3 class="text-lg font-bold text-gray-800 mb-3 flex items-center">
                <svg class="w-5 h-5 mr-2 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                </svg>
                üìä Speed Thresholds by Connection (with 10.0% tolerance)
            </h3>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                <div class="bg-gray-50 rounded-lg p-3">
                    <span class="font-semibold text-gray-700">Ethernet:</span>
                    <span class="text-blue-600">‚â•180 Mbps</span>
                    <span class="text-xs text-gray-500">(200 ¬±10%)</span>
                </div>
                <div class="bg-gray-50 rounded-lg p-3">
                    <span class="font-semibold text-gray-700">Wi-Fi 5GHz:</span>
                    <span class="text-blue-600">‚â•180 Mbps</span>
                    <span class="text-xs text-gray-500">(200 ¬±10%)</span>
                </div>
                <div class="bg-gray-50 rounded-lg p-3">
                    <span class="font-semibold text-gray-700">Wi-Fi 2.4GHz:</span>
                    <span class="text-blue-600">‚â•90 Mbps</span>
                    <span class="text-xs text-gray-500">(100 ¬±10%)</span>
                </div>
                <div class="bg-gray-50 rounded-lg p-3">
                    <span class="font-semibold text-gray-700">Unknown:</span>
                    <span class="text-blue-600">‚â•135 Mbps</span>
                    <span class="text-xs text-gray-500">(150 ¬±10%)</span>
                </div>
            </div>
        </div>

        <!-- Connection Type Statistics -->
        {% if connection_stats %}
        <div class="glass rounded-2xl p-6 mb-8 smooth-transition">
            <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                <svg class="w-6 h-6 mr-2 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
                </svg>
                üìà Stats by Connection Type
            </h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                {% for conn_type, stats_data in connection_stats.items() %}
                <div class="bg-gradient-to-br from-white to-gray-50 rounded-xl p-5 border border-gray-200 hover:shadow-lg smooth-transition">
                    <div class="flex items-center justify-between mb-3">
                        <h4 class="text-lg font-bold text-gray-800">{{ conn_type }}</h4>
                        <span class="px-3 py-1 bg-blue-100 text-blue-800 rounded-full text-sm font-semibold">
                            {{ stats_data.count }} tests
                        </span>
                    </div>
                    <div class="space-y-2">
                        <div class="flex justify-between items-center">
                            <span class="text-sm text-gray-600">Average Speed:</span>
                            <span class="font-bold text-lg {% if stats_data.avg >= stats_data.min_threshold %}text-green-600{% else %}text-red-600{% endif %}">
                                {{ stats_data.avg }} Mbps
                            </span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-sm text-gray-600">Minimum Threshold:</span>
                            <span class="font-semibold text-gray-700">‚â•{{ stats_data.min_threshold }} Mbps</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-sm text-gray-600">Below Minimum:</span>
                            <span class="font-semibold {% if stats_data.below_pct > 50 %}text-red-600{% elif stats_data.below_pct > 25 %}text-yellow-600{% else %}text-green-600{% endif %}">
                                {{ stats_data.below_min }} ({{ stats_data.below_pct }}%)
                            </span>
                        </div>
                        <!-- Progress Bar -->
                        <div class="mt-3">
                            <div class="w-full bg-gray-200 rounded-full h-2">
                                <div class="{% if stats_data.below_pct > 50 %}bg-red-500{% elif stats_data.below_pct > 25 %}bg-yellow-500{% else %}bg-green-500{% endif %} h-2 rounded-full smooth-transition" 
                                     style="width: {{ 100 - stats_data.below_pct }}%"></div>
                            </div>
                            <p class="text-xs text-gray-500 mt-1 text-center">
                                {{ 100 - stats_data.below_pct|round(1) }}% meeting threshold
                            </p>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}

        <!-- Additional Insights -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
            <!-- Days Below Expected Card -->
            <div class="glass rounded-2xl p-6 smooth-transition">
                <h3 class="text-lg font-bold text-gray-800 mb-4 flex items-center">
                    <svg class="w-5 h-5 mr-2 text-orange-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                    </svg>
                    Performance Alert
                </h3>
                <div class="text-center py-4">
                    <p class="text-4xl font-bold {% if summary.below_expected > summary.total_days / 2 %}text-red-600{% else %}text-green-600{% endif %} mb-2">
                        {{ summary.below_expected }} / {{ summary.total_days }}
                    </p>
                    <p class="text-sm text-gray-600">Days Below Expected Speed</p>
                    <p class="text-xs text-gray-500 mt-2">Threshold: {{ threshold }} Mbps</p>
                </div>
            </div>

            <!-- Top Server Card -->
            <div class="glass rounded-2xl p-6 smooth-transition">
                <h3 class="text-lg font-bold text-gray-800 mb-4 flex items-center">
                    <svg class="w-5 h-5 mr-2 text-teal-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 12h14M5 12a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v4a2 2 0 01-2 2M5 12a2 2 0 00-2 2v4a2 2 0 002 2h14a2 2 0 002-2v-4a2 2 0 00-2-2m-2-4h.01M17 16h.01"/>
                    </svg>
                    Most Used Server
                </h3>
                <div class="bg-gradient-to-br from-teal-50 to-blue-50 rounded-lg p-4">
                    <p class="text-sm font-semibold text-gray-700 break-words">
                        {{ summary.top_server_over_period }}
                    </p>
                    <p class="text-xs text-gray-500 mt-2">Format: Name ‚Äì Host ‚Äì City (Country)</p>
                </div>
                {% if summary.public_ips %}
                <div class="mt-4">
                    <p class="text-sm font-semibold text-gray-700 mb-2">Public IP(s) Observed:</p>
                    <div class="flex flex-wrap gap-2">
                        {% for ip in summary.public_ips %}
                        <span class="px-3 py-1 bg-blue-100 text-blue-800 rounded-full text-xs font-mono">
                            {{ ip }}
                        </span>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Percentile Statistics (Industry Standard) -->
        {% if percentiles %}
        <div class="glass rounded-2xl p-6 mb-8 smooth-transition">
            <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                <svg class="w-6 h-6 mr-2 text-cyan-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
                </svg>
                üìà Percentile Statistics <span class="text-sm font-normal text-gray-500 ml-2">(Industry Standard Metrics)</span>
            </h3>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <!-- Download Percentiles -->
                <div class="bg-gradient-to-br from-indigo-50 to-purple-50 rounded-xl p-5 border border-indigo-200">
                    <h4 class="font-semibold text-gray-700 mb-3 flex items-center">
                        <svg class="w-4 h-4 mr-1 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M9 19l3 3m0 0l3-3m-3 3V10"/>
                        </svg>
                        Download Speed
                    </h4>
                    <div class="space-y-2">
                        <div class="flex justify-between items-center">
                            <span class="text-sm text-gray-600">P50 (Median):</span>
                            <span class="font-bold text-indigo-700">{{ percentiles.download_p50 }} Mbps</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-sm text-gray-600">P95:</span>
                            <span class="font-bold text-indigo-700">{{ percentiles.download_p95 }} Mbps</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-sm text-gray-600">P99:</span>
                            <span class="font-bold text-indigo-700">{{ percentiles.download_p99 }} Mbps</span>
                        </div>
                    </div>
                </div>

                <!-- Upload Percentiles -->
                <div class="bg-gradient-to-br from-purple-50 to-pink-50 rounded-xl p-5 border border-purple-200">
                    <h4 class="font-semibold text-gray-700 mb-3 flex items-center">
                        <svg class="w-4 h-4 mr-1 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/>
                        </svg>
                        Upload Speed
                    </h4>
                    <div class="space-y-2">
                        <div class="flex justify-between items-center">
                            <span class="text-sm text-gray-600">P50 (Median):</span>
                            <span class="font-bold text-purple-700">{{ percentiles.upload_p50 }} Mbps</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-sm text-gray-600">P95:</span>
                            <span class="font-bold text-purple-700">{{ percentiles.upload_p95 }} Mbps</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-sm text-gray-600">P99:</span>
                            <span class="font-bold text-purple-700">{{ percentiles.upload_p99 }} Mbps</span>
                        </div>
                    </div>
                </div>

                <!-- Ping Percentiles -->
                <div class="bg-gradient-to-br from-green-50 to-teal-50 rounded-xl p-5 border border-green-200">
                    <h4 class="font-semibold text-gray-700 mb-3 flex items-center">
                        <svg class="w-4 h-4 mr-1 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
                        </svg>
                        Ping Latency
                    </h4>
                    <div class="space-y-2">
                        <div class="flex justify-between items-center">
                            <span class="text-sm text-gray-600">P50 (Median):</span>
                            <span class="font-bold text-green-700">{{ percentiles.ping_p50 }} ms</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-sm text-gray-600">P95:</span>
                            <span class="font-bold text-green-700">{{ percentiles.ping_p95 }} ms</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-sm text-gray-600">P99:</span>
                            <span class="font-bold text-green-700">{{ percentiles.ping_p99 }} ms</span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="mt-4 p-4 bg-gradient-to-r from-blue-50 to-cyan-50 rounded-lg border border-blue-200">
                <p class="text-sm text-gray-700 text-center">
                    <strong>üìä Quick Guide:</strong> 
                    <span class="font-semibold text-blue-700">P50</span> = Typical speed (half are faster, half slower) | 
                    <span class="font-semibold text-indigo-700">P95</span> = 95% of tests were this fast or faster than this value | 
                    <span class="font-semibold text-purple-700">P99</span> = Peak performance (99% achieved this or better than this value)
                </p>
                <p class="text-xs text-gray-600 text-center mt-2">
                    üí° <strong>For Download/Upload:</strong> Higher percentiles = Better performance | 
                    <strong>For Ping:</strong> Lower percentiles = Better latency (lower ping is better!)
                </p>
            </div>
        </div>
        {% endif %}

        <!-- Historical Best/Worst Records -->
        {% if historical_records %}
        <div class="glass rounded-2xl p-6 mb-8 smooth-transition">
            <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                <svg class="w-6 h-6 mr-2 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z"/>
                </svg>
                üèÜ Historical Records <span class="text-sm font-normal text-gray-500 ml-2">(All-Time Best Performance)</span>
            </h3>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                <!-- Best Download -->
                <div class="bg-gradient-to-br from-yellow-50 to-amber-50 rounded-xl p-4 border-2 border-yellow-300 smooth-transition hover:shadow-lg">
                    <div class="flex items-center mb-2">
                        <svg class="w-5 h-5 text-yellow-600 mr-2" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/>
                        </svg>
                        <h4 class="font-semibold text-gray-700">Fastest Download</h4>
                    </div>
                    <p class="text-2xl font-bold text-yellow-700 mb-1">{{ historical_records.best_download.value }} Mbps</p>
                    <p class="text-xs text-gray-600">{{ historical_records.best_download.date[:10] }}</p>
                    {% if historical_records.best_download.server %}
                    <p class="text-xs text-gray-500 mt-1 truncate" title="{{ historical_records.best_download.server }}">{{ historical_records.best_download.server[:30] }}...</p>
                    {% endif %}
                </div>

                <!-- Worst Download -->
                <div class="bg-gradient-to-br from-red-50 to-orange-50 rounded-xl p-4 border-2 border-red-200 smooth-transition hover:shadow-lg">
                    <div class="flex items-center mb-2">
                        <svg class="w-5 h-5 text-red-600 mr-2" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/>
                        </svg>
                        <h4 class="font-semibold text-gray-700">Slowest Download</h4>
                    </div>
                    <p class="text-2xl font-bold text-red-700 mb-1">{{ historical_records.worst_download.value }} Mbps</p>
                    <p class="text-xs text-gray-600">{{ historical_records.worst_download.date[:10] }}</p>
                </div>

                <!-- Best Upload -->
                <div class="bg-gradient-to-br from-blue-50 to-cyan-50 rounded-xl p-4 border-2 border-blue-300 smooth-transition hover:shadow-lg">
                    <div class="flex items-center mb-2">
                        <svg class="w-5 h-5 text-blue-600 mr-2" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/>
                        </svg>
                        <h4 class="font-semibold text-gray-700">Fastest Upload</h4>
                    </div>
                    <p class="text-2xl font-bold text-blue-700 mb-1">{{ historical_records.best_upload.value }} Mbps</p>
                    <p class="text-xs text-gray-600">{{ historical_records.best_upload.date[:10] }}</p>
                </div>

                <!-- Lowest Ping -->
                <div class="bg-gradient-to-br from-green-50 to-emerald-50 rounded-xl p-4 border-2 border-green-300 smooth-transition hover:shadow-lg">
                    <div class="flex items-center mb-2">
                        <svg class="w-5 h-5 text-green-600 mr-2" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/>
                        </svg>
                        <h4 class="font-semibold text-gray-700">Lowest Ping</h4>
                    </div>
                    <p class="text-2xl font-bold text-green-700 mb-1">{{ historical_records.lowest_ping.value }} ms</p>
                    <p class="text-xs text-gray-600">{{ historical_records.lowest_ping.date[:10] }}</p>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Filters Panel -->
        <div class="glass rounded-2xl p-6 mb-8 smooth-transition">
            <div class="flex items-center justify-between mb-6">
                <h2 class="text-2xl font-bold text-gray-800 flex items-center">
                    <svg class="w-6 h-6 mr-2 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z"/>
                    </svg>
                    Filters
                </h2>
                <button onclick="resetFilters()" class="px-4 py-2 bg-gradient-to-r from-blue-500 to-cyan-500 text-white rounded-lg hover:from-blue-600 hover:to-cyan-600 smooth-transition shadow-md hover:shadow-lg">
                    Reset Filters
                </button>
            </div>

            <!-- Quick Filters -->
            {% if quick_filters %}
            <div class="bg-gradient-to-r from-cyan-50 to-blue-50 rounded-xl p-5 mb-6 border-2 border-cyan-200">
                <h3 class="text-sm font-bold text-gray-700 mb-4 flex items-center">
                    <svg class="w-4 h-4 mr-2 text-cyan-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
                    </svg>
                    ‚ö° Quick Filters (Click to Apply)
                </h3>
                <div class="flex flex-wrap gap-2">
                    <!-- Performance Quick Filters -->
                    {% if quick_filters.below_threshold > 0 %}
                    <button type="button" onclick="applyQuickFilter('below_threshold')" class="quick-filter-btn px-4 py-2 bg-white border-2 border-orange-300 text-orange-700 rounded-lg hover:bg-orange-50 smooth-transition shadow-sm hover:shadow-md font-medium text-sm">
                        üîª Below {{ threshold }}Mbps
                        <span class="ml-1 px-2 py-0.5 bg-orange-100 rounded-full text-xs">{{ quick_filters.below_threshold }}</span>
                    </button>
                    {% endif %}
                    
                    {% if quick_filters.performance_drops > 0 %}
                    <button type="button" onclick="applyQuickFilter('performance_drops')" class="quick-filter-btn px-4 py-2 bg-white border-2 border-red-300 text-red-700 rounded-lg hover:bg-red-50 smooth-transition shadow-sm hover:shadow-md font-medium text-sm">
                        ‚ö†Ô∏è Drops <100 Mbps
                        <span class="ml-1 px-2 py-0.5 bg-red-100 rounded-full text-xs">{{ quick_filters.performance_drops }}</span>
                    </button>
                    {% endif %}
                    
                    {% if quick_filters.high_ping > 0 %}
                    <button type="button" onclick="applyQuickFilter('high_ping')" class="quick-filter-btn px-4 py-2 bg-white border-2 border-yellow-300 text-yellow-700 rounded-lg hover:bg-yellow-50 smooth-transition shadow-sm hover:shadow-md font-medium text-sm">
                        üì∂ High Ping >20ms
                        <span class="ml-1 px-2 py-0.5 bg-yellow-100 rounded-full text-xs">{{ quick_filters.high_ping }}</span>
                    </button>
                    {% endif %}
                    
                    <!-- ISP Quick Filters -->
                    {% for isp in quick_filters.isps %}
                    <button type="button" onclick="applyQuickFilter('isp', '{{ isp.name }}')" class="quick-filter-btn px-4 py-2 bg-white border-2 border-blue-300 text-blue-700 rounded-lg hover:bg-blue-50 smooth-transition shadow-sm hover:shadow-md font-medium text-sm">
                        üåê {{ isp.name }}
                        <span class="ml-1 px-2 py-0.5 bg-blue-100 rounded-full text-xs">{{ isp.count }}</span>
                    </button>
                    {% endfor %}
                    
                    <!-- Connection Type Quick Filters -->
                    {% for conn in quick_filters.connection_types %}
                    <button type="button" onclick="applyQuickFilter('connection', '{{ conn.name }}')" class="quick-filter-btn px-4 py-2 bg-white border-2 border-purple-300 text-purple-700 rounded-lg hover:bg-purple-50 smooth-transition shadow-sm hover:shadow-md font-medium text-sm">
                        üì° {{ conn.name }}
                        <span class="ml-1 px-2 py-0.5 bg-purple-100 rounded-full text-xs">{{ conn.count }}</span>
                    </button>
                    {% endfor %}
                    
                    <!-- Clear Quick Filters Button -->
                    <button type="button" onclick="clearQuickFilters()" class="quick-filter-btn px-4 py-2 bg-white border-2 border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 smooth-transition shadow-sm hover:shadow-md font-medium text-sm">
                        üîÑ Clear Filters
                    </button>
                </div>
            </div>
            {% endif %}
            
            <form method="POST" action="/dashboard" id="filterForm">
                <!-- Primary Controls Row -->
                <div class="bg-gradient-to-r from-blue-50 to-indigo-50 rounded-xl p-5 mb-6 border-2 border-blue-200">
                    <h3 class="text-sm font-bold text-gray-700 mb-4 flex items-center">
                        <svg class="w-4 h-4 mr-2 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        </svg>
                        ‚öôÔ∏è Primary Controls
                    </h3>
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                        <!-- View Mode -->
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Mode</label>
                            <select name="mode" id="viewMode" class="w-full px-4 py-2.5 border border-gray-300 rounded-lg smooth-transition focus:ring-2 focus:ring-blue-500 focus:border-blue-500 font-medium">
                                <option value="minute" {% if view_mode == 'minute' %}selected{% endif %}>15-min</option>
                                <option value="hourly" {% if view_mode == 'hourly' %}selected{% endif %}>Hourly</option>
                                <option value="daily" {% if view_mode == 'daily' %}selected{% endif %}>Daily</option>
                                <option value="weekly" {% if view_mode == 'weekly' %}selected{% endif %}>Weekly</option>
                                <option value="monthly" {% if view_mode == 'monthly' %}selected{% endif %}>Monthly</option>
                                <option value="yearly" {% if view_mode == 'yearly' %}selected{% endif %}>Yearly</option>
                            </select>
                        </div>

                        <!-- Period (Days) -->
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Period (Days)</label>
                            <select name="days" id="periodDays" class="w-full px-4 py-2.5 border border-gray-300 rounded-lg smooth-transition focus:ring-2 focus:ring-blue-500 focus:border-blue-500 font-medium">
                                <option value="1" {% if days == 1 %}selected{% endif %}>Last 1 day</option>
                                <option value="3" {% if days == 3 %}selected{% endif %}>Last 3 days</option>
                                <option value="7" {% if days == 7 %}selected{% endif %}>Last 7 days</option>
                                <option value="14" {% if days == 14 %}selected{% endif %}>Last 14 days</option>
                                <option value="30" {% if days == 30 %}selected{% endif %}>Last 30 days</option>
                                <option value="60" {% if days == 60 %}selected{% endif %}>Last 60 days</option>
                                <option value="90" {% if days == 90 %}selected{% endif %}>Last 90 days</option>
                                <option value="180" {% if days == 180 %}selected{% endif %}>Last 180 days</option>
                                <option value="365" {% if days == 365 %}selected{% endif %}>Last 365 days</option>
                            </select>
                        </div>

                        <!-- Threshold -->
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Threshold (Mbps)</label>
                            <input type="number" name="threshold" id="threshold" value="{{ threshold }}" step="0.1" placeholder="200.0" class="w-full px-4 py-2.5 border border-gray-300 rounded-lg smooth-transition focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        </div>

                        <!-- Show URLs Checkbox -->
                        <div class="flex items-end">
                            <label class="flex items-center space-x-3 cursor-pointer bg-white px-4 py-2.5 rounded-lg border border-gray-300 hover:bg-blue-50 smooth-transition w-full">
                                <input type="checkbox" name="urls" id="showUrls" value="yes" {% if show_urls %}checked{% endif %} class="w-5 h-5 text-blue-600 rounded focus:ring-2 focus:ring-blue-500">
                                <span class="text-sm font-semibold text-gray-700 flex items-center">
                                    <svg class="w-4 h-4 mr-1 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"/>
                                    </svg>
                                    Show URLs
                                </span>
                            </label>
                        </div>
                    </div>
                </div>

                <!-- Advanced Filters (Collapsible) -->
                <details class="mb-6">
                    <summary class="cursor-pointer glass rounded-2xl p-4 mb-4 hover:shadow-lg smooth-transition border border-blue-100">
                        <span class="text-sm font-bold bg-gradient-to-r from-blue-600 to-cyan-600 bg-clip-text text-transparent flex items-center">
                            <svg class="w-5 h-5 mr-2 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4"/>
                            </svg>
                            <span class="text-gray-700">üîç Advanced Filters</span>
                            <span class="text-xs font-normal text-gray-500 ml-2">(Date, Time, Speed Range)</span>
                        </span>
                    </summary>
                    
                    <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4 glass rounded-2xl p-6 mt-2 border border-blue-100">
                        <!-- Date From -->
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">üìÖ Date From</label>
                            <input type="date" name="date_from" id="dateFrom" value="{{ date_from }}" class="w-full px-3 py-2.5 text-sm border border-gray-300 rounded-lg smooth-transition focus:ring-2 focus:ring-blue-500 focus:border-blue-500 hover:border-blue-400 bg-white shadow-sm">
                        </div>

                        <!-- Date To -->
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">üìÖ Date To</label>
                            <input type="date" name="date_to" id="dateTo" value="{{ date_to }}" class="w-full px-3 py-2.5 text-sm border border-gray-300 rounded-lg smooth-transition focus:ring-2 focus:ring-blue-500 focus:border-blue-500 hover:border-blue-400 bg-white shadow-sm">
                        </div>

                        <!-- Time From -->
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">üïê Time From</label>
                            <input type="time" name="time_from" id="timeFrom" value="{{ time_from }}" class="w-full px-3 py-2.5 text-sm border border-gray-300 rounded-lg smooth-transition focus:ring-2 focus:ring-blue-500 focus:border-blue-500 hover:border-blue-400 bg-white shadow-sm">
                        </div>

                        <!-- Time To -->
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">üïê Time To</label>
                            <input type="time" name="time_to" id="timeTo" value="{{ time_to }}" class="w-full px-3 py-2.5 text-sm border border-gray-300 rounded-lg smooth-transition focus:ring-2 focus:ring-blue-500 focus:border-blue-500 hover:border-blue-400 bg-white shadow-sm">
                        </div>

                        <!-- Min Download -->
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">‚¨áÔ∏è Min Download</label>
                            <input type="number" name="min_download" id="minDownload" value="{{ min_download }}" step="0.1" placeholder="0" class="w-full px-3 py-2.5 text-sm border border-gray-300 rounded-lg smooth-transition focus:ring-2 focus:ring-blue-500 focus:border-blue-500 hover:border-blue-400 bg-white shadow-sm">
                        </div>

                        <!-- Max Download -->
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">‚¨áÔ∏è Max Download</label>
                            <input type="number" name="max_download" id="maxDownload" value="{{ max_download }}" step="0.1" placeholder="1000" class="w-full px-3 py-2.5 text-sm border border-gray-300 rounded-lg smooth-transition focus:ring-2 focus:ring-blue-500 focus:border-blue-500 hover:border-blue-400 bg-white shadow-sm">
                        </div>

                        <!-- Min Upload -->
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">‚¨ÜÔ∏è Min Upload</label>
                            <input type="number" name="min_upload" id="minUpload" value="{{ min_upload }}" step="0.1" placeholder="0" class="w-full px-3 py-2.5 text-sm border border-gray-300 rounded-lg smooth-transition focus:ring-2 focus:ring-blue-500 focus:border-blue-500 hover:border-blue-400 bg-white shadow-sm">
                        </div>

                        <!-- Max Upload -->
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">‚¨ÜÔ∏è Max Upload</label>
                            <input type="number" name="max_upload" id="maxUpload" value="{{ max_upload }}" step="0.1" placeholder="1000" class="w-full px-3 py-2.5 text-sm border border-gray-300 rounded-lg smooth-transition focus:ring-2 focus:ring-blue-500 focus:border-blue-500 hover:border-blue-400 bg-white shadow-sm">
                        </div>

                        <!-- Connection Type -->
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">üì° Connection</label>
                            <select name="connection_type" id="connectionType" class="w-full px-3 py-2.5 text-sm border border-gray-300 rounded-lg smooth-transition focus:ring-2 focus:ring-blue-500 focus:border-blue-500 hover:border-blue-400 bg-white shadow-sm">
                                <option value="">All Types</option>
                                <option value="wifi" {% if connection_type == 'wifi' %}selected{% endif %}>WiFi</option>
                                <option value="ethernet" {% if connection_type == 'ethernet' %}selected{% endif %}>Ethernet</option>
                                <option value="mobile" {% if connection_type == 'mobile' %}selected{% endif %}>Mobile</option>
                            </select>
                        </div>

                        <!-- ISP -->
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">üåê ISP</label>
                            <input type="text" name="isp" id="ispFilter" value="{{ isp }}" placeholder="All ISPs" class="w-full px-3 py-2.5 text-sm border border-gray-300 rounded-lg smooth-transition focus:ring-2 focus:ring-blue-500 focus:border-blue-500 hover:border-blue-400 bg-white shadow-sm">
                        </div>

                        <!-- Min Ping -->
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">üì∂ Min Ping (ms)</label>
                            <input type="number" name="min_ping" id="minPing" value="{{ min_ping }}" step="0.1" placeholder="0" class="w-full px-3 py-2.5 text-sm border border-gray-300 rounded-lg smooth-transition focus:ring-2 focus:ring-blue-500 focus:border-blue-500 hover:border-blue-400 bg-white shadow-sm">
                        </div>

                        <!-- Max Ping -->
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">üì∂ Max Ping (ms)</label>
                            <input type="number" name="max_ping" id="maxPing" value="{{ max_ping }}" step="0.1" placeholder="1000" class="w-full px-3 py-2.5 text-sm border border-gray-300 rounded-lg smooth-transition focus:ring-2 focus:ring-blue-500 focus:border-blue-500 hover:border-blue-400 bg-white shadow-sm">
                        </div>

                    <!-- Apply Button -->
                    <div class="flex items-end col-span-2 md:col-span-3 lg:col-span-4">
                        <button type="submit" class="w-full px-8 py-3.5 bg-gradient-to-r from-blue-600 to-cyan-500 text-white font-bold rounded-xl hover:from-blue-700 hover:to-cyan-600 smooth-transition shadow-lg hover:shadow-xl transform hover:scale-[1.02] flex items-center justify-center">
                            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z"/>
                            </svg>
                            Apply Filters
                        </button>
                    </div>
                </div>
            </form>
        </div>

        <!-- Charts Section -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
            <!-- Download/Upload Chart -->
            <div class="glass rounded-2xl p-6 smooth-transition hover-lift">
                <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                    <svg class="w-5 h-5 mr-2 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 12l3-3 3 3 4-4M8 21l4-4 4 4M3 4h18M4 4h16v12a1 1 0 01-1 1H5a1 1 0 01-1-1V4z"/>
                    </svg>
                    Download & Upload Speed
                </h3>
                <div id="speedChart" class="chart-container"></div>
            </div>

            <!-- Ping Chart -->
            <div class="glass rounded-2xl p-6 smooth-transition hover-lift">
                <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                    <svg class="w-5 h-5 mr-2 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"/>
                    </svg>
                    Ping Latency
                </h3>
                <div id="pingChart" class="chart-container"></div>
            </div>
        </div>

        <!-- Connection Type Comparison Chart -->
        <div class="glass rounded-2xl p-6 mb-8 smooth-transition">
            <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                <svg class="w-6 h-6 mr-2 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
                </svg>
                üì° Performance by Connection Type <span class="text-sm font-normal text-gray-500 ml-2">(Download & Upload Comparison)</span>
            </h3>
            <div id="connectionTypeChart" style="height: 450px;"></div>
        </div>

        <!-- Data Table -->
        <div class="glass rounded-2xl p-6 smooth-transition">
            <div class="flex items-center justify-between mb-6">
                <h2 class="text-2xl font-bold text-gray-800 flex items-center">
                    <svg class="w-6 h-6 mr-2 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                    </svg>
                    Speed Test Data
                    <span class="ml-3 px-3 py-1 bg-indigo-100 text-indigo-800 text-sm font-semibold rounded-full pulse-subtle">
                        {{ data|length }} records
                    </span>
                </h2>
                <div class="flex items-center space-x-3">
                    <button onclick="exportToCSV()" class="px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 smooth-transition shadow-md hover:shadow-lg flex items-center">
                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                        </svg>
                        Export CSV
                    </button>
                </div>
            </div>

            <!-- Table Connection Filter -->
            <div class="mb-4 bg-gradient-to-r from-blue-50 to-cyan-50 rounded-lg p-4 border border-blue-200">
                <div class="flex items-center justify-between mb-3">
                    <label class="text-sm font-semibold text-gray-700 flex items-center">
                        <svg class="w-4 h-4 mr-2 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z"/>
                        </svg>
                        üìã Table Connection Filter:
                    </label>
                    <div class="text-sm text-gray-600">
                        <span id="visibleRows">{{ data|length }}</span> / {{ data|length }} rows visible
                    </div>
                </div>
                <div class="flex flex-wrap gap-4">
                    <label class="flex items-center space-x-2 cursor-pointer">
                        <input type="checkbox" value="Wi-Fi 5GHz" class="connection-filter w-4 h-4 text-blue-600 rounded focus:ring-2 focus:ring-blue-500" onchange="filterTableByConnection()">
                        <span class="text-sm text-gray-700">Wi-Fi 5GHz</span>
                    </label>
                    <label class="flex items-center space-x-2 cursor-pointer">
                        <input type="checkbox" value="Wi-Fi 2.4GHz" class="connection-filter w-4 h-4 text-blue-600 rounded focus:ring-2 focus:ring-blue-500" onchange="filterTableByConnection()">
                        <span class="text-sm text-gray-700">Wi-Fi 2.4GHz</span>
                    </label>
                    <label class="flex items-center space-x-2 cursor-pointer">
                        <input type="checkbox" value="Ethernet" class="connection-filter w-4 h-4 text-blue-600 rounded focus:ring-2 focus:ring-blue-500" onchange="filterTableByConnection()">
                        <span class="text-sm text-gray-700">Ethernet</span>
                    </label>
                    <label class="flex items-center space-x-2 cursor-pointer">
                        <input type="checkbox" value="Unknown" class="connection-filter w-4 h-4 text-blue-600 rounded focus:ring-2 focus:ring-blue-500" onchange="filterTableByConnection()">
                        <span class="text-sm text-gray-700">Unknown</span>
                    </label>
                    <button onclick="clearConnectionFilters()" class="ml-4 px-3 py-1 text-xs bg-white border border-blue-300 text-blue-700 rounded-lg hover:bg-blue-50 smooth-transition">
                        Clear All
                    </button>
                </div>
            </div>

            <div class="overflow-x-auto rounded-lg">
                <table class="data-table" id="dataTable">
                    <thead>
                        <tr>
                            <th class="cursor-pointer hover:bg-indigo-700 smooth-transition" onclick="sortTable(0)">
                                Timestamp 
                                <svg class="w-4 h-4 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16V4m0 0L3 8m4-4l4 4m6 0v12m0 0l4-4m-4 4l-4-4"/>
                                </svg>
                            </th>
                            <th class="cursor-pointer hover:bg-indigo-700 smooth-transition" onclick="sortTable(1)">
                                Download (Mbps)
                                <svg class="w-4 h-4 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16V4m0 0L3 8m4-4l4 4m6 0v12m0 0l4-4m-4 4l-4-4"/>
                                </svg>
                            </th>
                            <th class="cursor-pointer hover:bg-indigo-700 smooth-transition" onclick="sortTable(2)">
                                Upload (Mbps)
                                <svg class="w-4 h-4 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16V4m0 0L3 8m4-4l4 4m6 0v12m0 0l4-4m-4 4l-4-4"/>
                                </svg>
                            </th>
                            <th class="cursor-pointer hover:bg-indigo-700 smooth-transition" onclick="sortTable(3)">
                                Ping (ms)
                                <svg class="w-4 h-4 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16V4m0 0L3 8m4-4l4 4m6 0v12m0 0l4-4m-4 4l-4-4"/>
                                </svg>
                            </th>
                            <th>Server</th>
                            <th>Public IP</th>
                            <th>Connection</th>
                            {% if show_urls %}
                            <th>Result URLs</th>
                            {% endif %}
                        </tr>
                    </thead>
                    <tbody>
                        {% for record in data %}
                        <tr class="smooth-transition">
                            <td class="font-medium text-gray-900">{{ record.date_ist_str or record.date_ist }}</td>
                            <td>
                                <span class="badge bg-indigo-100 text-indigo-800">
                                    {{ "%.2f"|format(record.download_avg or 0) }}
                                </span>
                            </td>
                            <td>
                                <span class="badge bg-purple-100 text-purple-800">
                                    {{ "%.2f"|format(record.upload_avg or 0) }}
                                </span>
                            </td>
                            <td>
                                {% set ping_val = record.ping_avg or 0 %}
                                {% if ping_val < 20 %}
                                <span class="badge bg-green-100 text-green-800" title="Excellent - Low latency">
                                    {{ "%.2f"|format(ping_val) }}
                                </span>
                                {% elif ping_val < 50 %}
                                <span class="badge bg-yellow-100 text-yellow-800" title="Good - Moderate latency">
                                    {{ "%.2f"|format(ping_val) }}
                                </span>
                                {% elif ping_val < 100 %}
                                <span class="badge bg-orange-100 text-orange-800" title="Fair - Higher latency">
                                    {{ "%.2f"|format(ping_val) }}
                                </span>
                                {% else %}
                                <span class="badge bg-red-100 text-red-800" title="Poor - High latency">
                                    {{ "%.2f"|format(ping_val) }}
                                </span>
                                {% endif %}
                            </td>
                            <td class="text-gray-600">{{ record.top_server or 'N/A' }}</td>
                            <td class="text-gray-600">{{ record.public_ip or 'N/A' }}</td>
                            <td>
                                {% if record.connection_type == 'wifi' or 'wifi' in (record.connection_type or '').lower() %}
                                <span class="badge bg-blue-100 text-blue-800">
                                    <svg class="w-3 h-3 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.111 16.404a5.5 5.5 0 017.778 0M12 20h.01m-7.08-7.071c3.904-3.905 10.236-3.905 14.141 0M1.394 9.393c5.857-5.857 15.355-5.857 21.213 0"/>
                                    </svg>
                                    WiFi
                                </span>
                                {% elif record.connection_type == 'ethernet' or 'ethernet' in (record.connection_type or '').lower() %}
                                <span class="badge bg-gray-100 text-gray-800">
                                    <svg class="w-3 h-3 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 12h14M5 12a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v4a2 2 0 01-2 2M5 12a2 2 0 00-2 2v4a2 2 0 002 2h14a2 2 0 002-2v-4a2 2 0 00-2-2m-2-4h.01M17 16h.01"/>
                                    </svg>
                                    Ethernet
                                </span>
                                {% else %}
                                <span class="badge bg-orange-100 text-orange-800">
                                    {{ record.connection_type or 'Unknown' }}
                                </span>
                                {% endif %}
                            </td>
                            {% if show_urls %}
                            <td>
                                {% if record.result_urls and record.result_urls|length > 0 %}
                                    {% for url in record.result_urls %}
                                    <a href="{{ url }}" target="_blank" class="inline-flex items-center text-blue-600 hover:text-blue-800 text-xs mr-2 mb-1 smooth-transition">
                                        <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"/>
                                        </svg>
                                        Result #{{ loop.index }}
                                    </a>
                                    {% if not loop.last %}<br>{% endif %}
                                    {% endfor %}
                                {% else %}
                                <span class="text-gray-400 text-xs">No URLs</span>
                                {% endif %}
                            </td>
                            {% endif %}
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="glass-dark mt-12 py-6">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 text-center text-white">
            <p class="text-sm">
                Speed Test Dashboard &copy; 2025 | Developed by <strong>Varadharajan</strong> | 
                <a href="https://github.com/varadharajaan/internet-speed-tester" target="_blank" class="hover:text-indigo-300 smooth-transition font-semibold">
                    <svg class="w-4 h-4 inline-block mr-1" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/>
                    </svg>
                    View on GitHub
                </a>
            </p>
        </div>
    </footer>

    <script>
        // Chart Data Preparation
        const chartData = {{ chart_data|tojson }};
        
        // Initialize Speed Chart (Download + Upload)
        function initSpeedChart() {
            const speedChart = echarts.init(document.getElementById('speedChart'));
            
            const option = {
                backgroundColor: 'transparent',
                tooltip: {
                    trigger: 'axis',
                    axisPointer: {
                        type: 'cross',
                        label: {
                            backgroundColor: '#6366f1'
                        }
                    },
                    backgroundColor: 'rgba(255, 255, 255, 0.95)',
                    borderColor: '#e5e7eb',
                    borderWidth: 1,
                    textStyle: {
                        color: '#1f2937'
                    },
                    formatter: function(params) {
                        let result = params[0].name + '<br/>';
                        params.forEach(param => {
                            result += param.marker + ' ' + param.seriesName + ': <b>' + param.value.toFixed(2) + ' Mbps</b><br/>';
                        });
                        return result;
                    }
                },
                legend: {
                    data: ['Download', 'Upload'],
                    top: 10,
                    textStyle: {
                        color: '#4b5563',
                        fontSize: 12,
                        fontWeight: 600
                    }
                },
                grid: {
                    left: '3%',
                    right: '4%',
                    bottom: '3%',
                    top: '15%',
                    containLabel: true
                },
                toolbox: {
                    feature: {
                        dataZoom: {
                            yAxisIndex: 'none'
                        },
                        restore: {},
                        saveAsImage: {
                            name: 'speed_chart',
                            pixelRatio: 2
                        }
                    },
                    iconStyle: {
                        borderColor: '#667eea'
                    }
                },
                xAxis: {
                    type: 'category',
                    boundaryGap: false,
                    data: chartData.timestamps,
                    axisLine: {
                        lineStyle: {
                            color: '#d1d5db'
                        }
                    },
                    axisLabel: {
                        color: '#6b7280',
                        rotate: 45,
                        fontSize: 10
                    }
                },
                yAxis: {
                    type: 'value',
                    name: 'Speed (Mbps)',
                    nameTextStyle: {
                        color: '#6b7280',
                        fontSize: 12
                    },
                    axisLine: {
                        lineStyle: {
                            color: '#d1d5db'
                        }
                    },
                    axisLabel: {
                        color: '#6b7280'
                    },
                    splitLine: {
                        lineStyle: {
                            color: '#f3f4f6'
                        }
                    }
                },
                series: [
                    {
                        name: 'Download',
                        type: 'line',
                        smooth: true,
                        symbol: 'circle',
                        symbolSize: 6,
                        sampling: 'average',
                        itemStyle: {
                            color: '#6366f1'
                        },
                        areaStyle: {
                            color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                                {
                                    offset: 0,
                                    color: 'rgba(99, 102, 241, 0.3)'
                                },
                                {
                                    offset: 1,
                                    color: 'rgba(99, 102, 241, 0.05)'
                                }
                            ])
                        },
                        lineStyle: {
                            width: 3
                        },
                        data: chartData.download,
                        markLine: {
                            silent: true,
                            lineStyle: {
                                color: '#6366f1',
                                type: 'dashed',
                                width: 2
                            },
                            data: [
                                {
                                    type: 'average',
                                    name: 'Average'
                                },
                                {
                                    yAxis: 200,
                                    name: 'Target (200 Mbps)',
                                    lineStyle: {
                                        color: '#10b981',
                                        type: 'solid',
                                        width: 2
                                    },
                                    label: {
                                        show: true,
                                        position: 'end',
                                        formatter: '200 Mbps Target'
                                    }
                                }
                            ]
                        }
                    },
                    {
                        name: 'Upload',
                        type: 'line',
                        smooth: true,
                        symbol: 'circle',
                        symbolSize: 6,
                        sampling: 'average',
                        itemStyle: {
                            color: '#a855f7'
                        },
                        areaStyle: {
                            color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                                {
                                    offset: 0,
                                    color: 'rgba(168, 85, 247, 0.3)'
                                },
                                {
                                    offset: 1,
                                    color: 'rgba(168, 85, 247, 0.05)'
                                }
                            ])
                        },
                        lineStyle: {
                            width: 3
                        },
                        data: chartData.upload,
                        markLine: {
                            silent: true,
                            lineStyle: {
                                color: '#a855f7',
                                type: 'dashed'
                            },
                            data: [{
                                type: 'average',
                                name: 'Average'
                            }]
                        }
                    }
                ],
                dataZoom: [
                    {
                        type: 'inside',
                        start: 0,
                        end: 100
                    },
                    {
                        start: 0,
                        end: 100,
                        handleIcon: 'path://M10.7,11.9v-1.3H9.3v1.3c-4.9,0.3-8.8,4.4-8.8,9.4c0,5,3.9,9.1,8.8,9.4v1.3h1.4v-1.3c4.9-0.3,8.8-4.4,8.8-9.4C19.5,16.3,15.6,12.2,10.7,11.9z',
                        handleSize: '80%',
                        handleStyle: {
                            color: '#667eea'
                        },
                        textStyle: {
                            color: '#6b7280'
                        }
                    }
                ]
            };
            
            speedChart.setOption(option);
            
            // Responsive resize
            window.addEventListener('resize', () => speedChart.resize());
        }

        // Initialize Ping Chart
        function initPingChart() {
            const pingChart = echarts.init(document.getElementById('pingChart'));
            
            const option = {
                backgroundColor: 'transparent',
                tooltip: {
                    trigger: 'axis',
                    axisPointer: {
                        type: 'shadow',
                        label: {
                            backgroundColor: '#10b981'
                        }
                    },
                    backgroundColor: 'rgba(255, 255, 255, 0.95)',
                    borderColor: '#e5e7eb',
                    borderWidth: 1,
                    textStyle: {
                        color: '#1f2937'
                    },
                    formatter: function(params) {
                        return params[0].name + '<br/>' + 
                               params[0].marker + ' Ping: <b>' + params[0].value.toFixed(2) + ' ms</b>';
                    }
                },
                legend: {
                    data: ['Ping'],
                    top: 10,
                    textStyle: {
                        color: '#4b5563',
                        fontSize: 12,
                        fontWeight: 600
                    }
                },
                grid: {
                    left: '3%',
                    right: '4%',
                    bottom: '3%',
                    top: '15%',
                    containLabel: true
                },
                toolbox: {
                    feature: {
                        dataZoom: {
                            yAxisIndex: 'none'
                        },
                        restore: {},
                        saveAsImage: {
                            name: 'ping_chart',
                            pixelRatio: 2
                        }
                    },
                    iconStyle: {
                        borderColor: '#10b981'
                    }
                },
                xAxis: {
                    type: 'category',
                    boundaryGap: false,
                    data: chartData.timestamps,
                    axisLine: {
                        lineStyle: {
                            color: '#d1d5db'
                        }
                    },
                    axisLabel: {
                        color: '#6b7280',
                        rotate: 45,
                        fontSize: 10
                    }
                },
                yAxis: {
                    type: 'value',
                    name: 'Latency (ms)',
                    nameTextStyle: {
                        color: '#6b7280',
                        fontSize: 12
                    },
                    axisLine: {
                        lineStyle: {
                            color: '#d1d5db'
                        }
                    },
                    axisLabel: {
                        color: '#6b7280'
                    },
                    splitLine: {
                        lineStyle: {
                            color: '#f3f4f6'
                        }
                    }
                },
                series: [
                    {
                        name: 'Ping',
                        type: 'line',
                        smooth: true,
                        symbol: 'circle',
                        symbolSize: 6,
                        sampling: 'average',
                        itemStyle: {
                            color: '#10b981'
                        },
                        areaStyle: {
                            color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                                {
                                    offset: 0,
                                    color: 'rgba(16, 185, 129, 0.3)'
                                },
                                {
                                    offset: 1,
                                    color: 'rgba(16, 185, 129, 0.05)'
                                }
                            ])
                        },
                        lineStyle: {
                            width: 3
                        },
                        data: chartData.ping,
                        markLine: {
                            silent: true,
                            lineStyle: {
                                color: '#10b981',
                                type: 'dashed',
                                width: 2
                            },
                            data: [
                                {
                                    type: 'average',
                                    name: 'Average'
                                },
                                {
                                    yAxis: 20,
                                    name: 'Excellent (<20ms)',
                                    lineStyle: {
                                        color: '#10b981',
                                        type: 'dotted',
                                        width: 2
                                    },
                                    label: {
                                        show: true,
                                        position: 'insideEndTop',
                                        formatter: 'Excellent: <20ms'
                                    }
                                },
                                {
                                    yAxis: 50,
                                    name: 'Good (<50ms)',
                                    lineStyle: {
                                        color: '#fbbf24',
                                        type: 'dotted',
                                        width: 2
                                    },
                                    label: {
                                        show: true,
                                        position: 'insideEndTop',
                                        formatter: 'Good: <50ms'
                                    }
                                }
                            ]
                        }
                    }
                ],
                dataZoom: [
                    {
                        type: 'inside',
                        start: 0,
                        end: 100
                    },
                    {
                        start: 0,
                        end: 100,
                        handleIcon: 'path://M10.7,11.9v-1.3H9.3v1.3c-4.9,0.3-8.8,4.4-8.8,9.4c0,5,3.9,9.1,8.8,9.4v1.3h1.4v-1.3c4.9-0.3,8.8-4.4,8.8-9.4C19.5,16.3,15.6,12.2,10.7,11.9z',
                        handleSize: '80%',
                        handleStyle: {
                            color: '#10b981'
                        },
                        textStyle: {
                            color: '#6b7280'
                        }
                    }
                ]
            };
            
            pingChart.setOption(option);
            
            // Responsive resize
            window.addEventListener('resize', () => pingChart.resize());
        }

        // Initialize Connection Type Comparison Chart (Combined Download & Upload)
        function initConnectionTypeCharts() {
            // Group data by connection type - use PRIMARY (first) connection only
            const connectionData = {};
            
            chartData.timestamps.forEach((timestamp, index) => {
                const rawConnection = chartData.connection_types ? chartData.connection_types[index] : 'Unknown';
                
                // If comma-separated (mixed connection during test), take ONLY the first one
                // This represents the primary connection type for that measurement
                const connection = rawConnection.split(',')[0].trim();
                
                if (!connectionData[connection]) {
                    connectionData[connection] = {
                        download: [],
                        upload: [],
                        timestamps: []
                    };
                }
                connectionData[connection].download.push(chartData.download[index]);
                connectionData[connection].upload.push(chartData.upload[index]);
                connectionData[connection].timestamps.push(timestamp);
            });

            // Debug: Log connection types found
            console.log('Connection types found:', Object.keys(connectionData));

            // Function to get color based on EXACT connection type
            function getColorForConnection(connectionType) {
                const conn = connectionType.trim();
                
                // Exact match for each connection type with vibrant colors
                if (conn === 'Wi-Fi 2.4GHz') {
                    return '#f59e0b'; // Amber/Orange for 2.4GHz
                }
                if (conn === 'Wi-Fi 5GHz') {
                    return '#10b981'; // Emerald Green for 5GHz
                }
                if (conn === 'Ethernet') {
                    return '#06b6d4'; // Cyan for Ethernet
                }
                if (conn === 'Mobile' || conn === 'Cellular') {
                    return '#8b5cf6'; // Violet for Mobile
                }
                if (conn === 'Unknown') {
                    return '#f43f5e'; // Rose/Pink for Unknown
                }
                
                // Fallback for any other variations
                const connLower = conn.toLowerCase();
                if (connLower.includes('2.4')) return '#f59e0b'; // Amber
                if (connLower.includes('5ghz') || connLower.includes('5 ghz')) return '#10b981'; // Emerald
                if (connLower.includes('ethernet')) return '#06b6d4'; // Cyan
                if (connLower.includes('mobile') || connLower.includes('cellular')) return '#8b5cf6'; // Violet
                
                return '#f43f5e'; // Rose/Pink
            }

            // Create combined series for both download and upload
            const combinedSeries = [];
            const legendData = [];
            
            Object.keys(connectionData).forEach(conn => {
                const connName = conn.charAt(0).toUpperCase() + conn.slice(1);
                const color = getColorForConnection(conn);
                
                console.log(`Connection: "${conn}" => Color: ${color}`); // Debug log
                
                legendData.push(connName); // Only add connection name once to legend
                
                // Download series - SOLID line
                combinedSeries.push({
                    name: connName,
                    type: 'line',
                    smooth: true,
                    symbol: 'circle',
                    symbolSize: 6,
                    data: connectionData[conn].download,
                    itemStyle: {
                        color: color
                    },
                    lineStyle: {
                        width: 3,
                        type: 'solid',
                        color: color
                    },
                    emphasis: {
                        focus: 'series',
                        itemStyle: {
                            color: color
                        },
                        lineStyle: {
                            color: color,
                            width: 4
                        }
                    }
                });
                
                // Upload series - DASHED line (same color, different style)
                combinedSeries.push({
                    name: connName,
                    type: 'line',
                    smooth: true,
                    symbol: 'triangle',
                    symbolSize: 6,
                    data: connectionData[conn].upload,
                    itemStyle: {
                        color: color
                    },
                    lineStyle: {
                        width: 2.5,
                        type: 'dashed',
                        color: color
                    },
                    emphasis: {
                        focus: 'series',
                        itemStyle: {
                            color: color
                        },
                        lineStyle: {
                            color: color,
                            width: 3.5
                        }
                    }
                });
            });

            // Initialize combined chart
            const connectionChart = echarts.init(document.getElementById('connectionTypeChart'));
            
            connectionChart.setOption({
                backgroundColor: 'transparent',
                tooltip: {
                    trigger: 'axis',
                    backgroundColor: 'rgba(255, 255, 255, 0.95)',
                    borderColor: '#e5e7eb',
                    borderWidth: 1,
                    textStyle: { color: '#1f2937' },
                    formatter: function(params) {
                        let result = '<strong>' + params[0].axisValue + '</strong><br/>';
                        
                        // Group by connection type
                        const grouped = {};
                        params.forEach(param => {
                            if (!grouped[param.seriesName]) {
                                grouped[param.seriesName] = { download: null, upload: null };
                            }
                            // Solid line = download, dashed = upload
                            if (param.seriesIndex % 2 === 0) {
                                grouped[param.seriesName].download = param.value;
                            } else {
                                grouped[param.seriesName].upload = param.value;
                            }
                        });
                        
                        // Format output
                        Object.keys(grouped).forEach(connName => {
                            result += '<div style="margin: 4px 0;">';
                            result += '<strong>' + connName + ':</strong><br/>';
                            if (grouped[connName].download !== null) {
                                result += '&nbsp;&nbsp;‚¨áÔ∏è Download: <b>' + grouped[connName].download.toFixed(2) + ' Mbps</b><br/>';
                            }
                            if (grouped[connName].upload !== null) {
                                result += '&nbsp;&nbsp;‚¨ÜÔ∏è Upload: <b>' + grouped[connName].upload.toFixed(2) + ' Mbps</b>';
                            }
                            result += '</div>';
                        });
                        
                        return result;
                    }
                },
                legend: {
                    data: legendData,
                    top: 10,
                    textStyle: { color: '#4b5563', fontSize: 12, fontWeight: 600 },
                    itemGap: 20,
                    // Enable selection for toggling visibility
                    selected: (() => {
                        const selected = {};
                        legendData.forEach(name => selected[name] = true);
                        return selected;
                    })(),
                    // Custom formatter to show visual indicators
                    formatter: function(name) {
                        return name;
                    }
                },
                grid: {
                    left: '3%',
                    right: '4%',
                    bottom: '8%',
                    top: '15%',
                    containLabel: true
                },
                toolbox: {
                    feature: {
                        dataZoom: {
                            yAxisIndex: 'none'
                        },
                        restore: {},
                        saveAsImage: {
                            name: 'connection_type_comparison',
                            pixelRatio: 2
                        }
                    },
                    iconStyle: {
                        borderColor: '#667eea'
                    },
                    top: 10,
                    right: 20
                },
                xAxis: {
                    type: 'category',
                    boundaryGap: false,
                    data: chartData.timestamps,
                    axisLine: { lineStyle: { color: '#d1d5db' } },
                    axisLabel: { color: '#6b7280', rotate: 45, fontSize: 10 }
                },
                yAxis: {
                    type: 'value',
                    name: 'Speed (Mbps)',
                    nameTextStyle: { color: '#6b7280', fontSize: 12 },
                    axisLine: { lineStyle: { color: '#d1d5db' } },
                    axisLabel: { color: '#6b7280' },
                    splitLine: { lineStyle: { color: '#f3f4f6' } }
                },
                series: combinedSeries,
                dataZoom: [
                    {
                        type: 'inside',
                        start: 0,
                        end: 100
                    },
                    {
                        start: 0,
                        end: 100,
                        handleIcon: 'path://M10.7,11.9v-1.3H9.3v1.3c-4.9,0.3-8.8,4.4-8.8,9.4c0,5,3.9,9.1,8.8,9.4v1.3h1.4v-1.3c4.9-0.3,8.8-4.4,8.8-9.4C19.5,16.3,15.6,12.2,10.7,11.9z',
                        handleSize: '80%',
                        handleStyle: {
                            color: '#667eea'
                        },
                        textStyle: {
                            color: '#6b7280'
                        }
                    }
                ]
            });

            // Responsive resize
            window.addEventListener('resize', () => connectionChart.resize());
        }

        // Initialize charts on page load
        document.addEventListener('DOMContentLoaded', function() {
            initSpeedChart();
            initPingChart();
            initConnectionTypeCharts();
            updatePeriodLabel(); // Initialize period label
            
            // Add event listener for view mode changes
            document.getElementById('viewMode').addEventListener('change', updatePeriodLabel);
        });

        // Update period label based on view mode
        function updatePeriodLabel() {
            const viewMode = document.getElementById('viewMode').value;
            const periodLabel = document.querySelector('label[for="periodDays"]');
            const periodSelect = document.getElementById('periodDays');
            
            const labelText = {
                'minute': 'Period (Days)',
                'hourly': 'Period (Days)',
                'daily': 'Period (Days)',
                'weekly': 'Period (Weeks)',
                'monthly': 'Period (Months)',
                'yearly': 'Period (Years)'
            };
            
            // Update the label text
            if (periodLabel && labelText[viewMode]) {
                periodLabel.textContent = labelText[viewMode];
            }
            
            // Optionally update dropdown options based on view mode
            // For now, keeping the same options for all modes
            // Could customize options per mode in future enhancement
        }

        // Reset Filters Function
        function resetFilters() {
            window.location.href = '/dashboard';
        }

        // Quick Filter Function (Client-side only - No server reload!)
        function applyQuickFilter(filterType, value) {
            const table = document.getElementById('dataTable');
            const tbody = table.querySelector('tbody');
            const rows = Array.from(tbody.querySelectorAll('tr'));
            
            // Reset all rows to visible first
            rows.forEach(row => row.style.display = '');
            
            // Apply filter based on type
            rows.forEach(row => {
                const cells = row.cells;
                let shouldHide = false;
                
                switch(filterType) {
                    case 'below_threshold':
                        // Column 1 is download speed
                        const downloadText = cells[1]?.textContent.trim();
                        const download = parseFloat(downloadText);
                        if (download >= {{ threshold }}) {
                            shouldHide = true;
                        }
                        break;
                        
                    case 'performance_drops':
                        // Show only rows with download < 100
                        const downloadDropText = cells[1]?.textContent.trim();
                        const downloadDrop = parseFloat(downloadDropText);
                        if (downloadDrop >= 100) {
                            shouldHide = true;
                        }
                        break;
                        
                    case 'high_ping':
                        // Show only rows with ping > 20
                        const pingText = cells[3]?.textContent.trim();
                        const ping = parseFloat(pingText);
                        if (ping <= 20) {
                            shouldHide = true;
                        }
                        break;
                        
                    case 'isp':
                        // Filter by ISP (not implemented in table, would need backend)
                        // For now, show message
                        console.log('ISP filter:', value);
                        // Fall through to use server-side filter
                        document.getElementById('ispFilter').value = value;
                        document.getElementById('filterForm').submit();
                        return;
                        
                    case 'connection':
                        // Column 6 is connection type
                        const connText = cells[6]?.textContent.toLowerCase();
                        if (!connText.includes(value.toLowerCase())) {
                            shouldHide = true;
                        }
                        break;
                }
                
                if (shouldHide) {
                    row.style.display = 'none';
                }
            });
            
            // Scroll to table
            table.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }

        // Clear Quick Filters (Show all rows)
        function clearQuickFilters() {
            const table = document.getElementById('dataTable');
            const tbody = table.querySelector('tbody');
            const rows = Array.from(tbody.querySelectorAll('tr'));
            
            // Show all rows
            rows.forEach(row => row.style.display = '');
        }

        // Table Sorting
        let sortDirection = {};
        
        function sortTable(columnIndex) {
            const table = document.getElementById('dataTable');
            const tbody = table.querySelector('tbody');
            const rows = Array.from(tbody.querySelectorAll('tr'));
            const headers = table.querySelectorAll('th');
            
            // Initialize to descending if first click
            if (sortDirection[columnIndex] === undefined) {
                sortDirection[columnIndex] = false; // false = descending
            } else {
                sortDirection[columnIndex] = !sortDirection[columnIndex];
            }
            const ascending = sortDirection[columnIndex];
            
            // Update header icons
            headers.forEach((header, idx) => {
                const svg = header.querySelector('svg');
                if (svg && idx === columnIndex) {
                    svg.style.transform = ascending ? 'rotate(180deg)' : 'rotate(0deg)';
                    svg.style.transition = 'transform 0.3s';
                }
            });
            
            rows.sort((a, b) => {
                let aValue = a.cells[columnIndex].textContent.trim();
                let bValue = b.cells[columnIndex].textContent.trim();
                
                // Try to parse as number
                const aNum = parseFloat(aValue);
                const bNum = parseFloat(bValue);
                
                if (!isNaN(aNum) && !isNaN(bNum)) {
                    return ascending ? aNum - bNum : bNum - aNum;
                }
                
                // String comparison (dates and text)
                return ascending ? 
                    aValue.localeCompare(bValue) : 
                    bValue.localeCompare(aValue);
            });
            
            // Rebuild table with animation
            rows.forEach((row, index) => {
                row.style.opacity = '0';
                setTimeout(() => {
                    tbody.appendChild(row);
                    row.style.opacity = '1';
                }, index * 10);
            });
        }

        // Filter Table by Connection Type (Multi-select)
        function filterTableByConnection() {
            const checkboxes = document.querySelectorAll('.connection-filter:checked');
            const selectedFilters = Array.from(checkboxes).map(cb => cb.value.toLowerCase());
            const table = document.getElementById('dataTable');
            const tbody = table.querySelector('tbody');
            const rows = tbody.querySelectorAll('tr');
            let visibleCount = 0;
            
            rows.forEach(row => {
                const connectionCell = row.cells[6]; // Connection is the 7th column (index 6)
                if (connectionCell) {
                    const connectionText = connectionCell.textContent.trim().toLowerCase();
                    
                    // If no filters selected, show all rows
                    if (selectedFilters.length === 0) {
                        row.style.display = '';
                        visibleCount++;
                    } else {
                        // Check if connection text contains ANY of the selected filter values
                        // This handles comma-separated values like "Wi-Fi 5GHz, Wi-Fi 2.4GHz"
                        const matchesFilter = selectedFilters.some(filter => connectionText.includes(filter));
                        
                        if (matchesFilter) {
                            row.style.display = '';
                            visibleCount++;
                        } else {
                            row.style.display = 'none';
                        }
                    }
                }
            });
            
            // Update visible count
            document.getElementById('visibleRows').textContent = visibleCount;
        }

        // Clear all connection filters
        function clearConnectionFilters() {
            const checkboxes = document.querySelectorAll('.connection-filter');
            checkboxes.forEach(cb => cb.checked = false);
            filterTableByConnection();
        }

        // Export to CSV (only visible rows)
        function exportToCSV() {
            const table = document.getElementById('dataTable');
            const rows = Array.from(table.querySelectorAll('tr'));
            
            const csv = rows.filter(row => {
                // Include header row or visible data rows
                return row.parentElement.tagName === 'THEAD' || row.style.display !== 'none';
            }).map(row => {
                const cells = Array.from(row.querySelectorAll('th, td'));
                return cells.map(cell => {
                    const text = cell.textContent.trim();
                    return '"' + text.replace(/"/g, '""') + '"';
                }).join(',');
            }).join('\n');
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'speed_test_data_' + new Date().toISOString().split('T')[0] + '.csv';
            a.click();
            window.URL.revokeObjectURL(url);
        }

        // Auto-refresh every 5 minutes (optional)
        // setInterval(() => {
        //     location.reload();
        // }, 300000);
    </script>
</body>
</html>
